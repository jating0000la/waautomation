<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Send Media - Multi-Phone</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/styles/app.css" />
  <style>
    .phone-selector {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 1px solid #2196f3;
      border-radius: 10px;
    }
    .account-option {
      cursor: pointer;
      transition: all 0.3s ease;
    }
    .account-option:hover {
      background-color: rgba(33, 150, 243, 0.1);
    }
    .account-option.selected {
      background-color: rgba(33, 150, 243, 0.2);
      border: 2px solid #2196f3;
    }
    .legacy-mode {
      background: linear-gradient(135deg, #fff3e0 0%, #fce4ec 100%);
      border: 1px solid #ff9800;
    }
    .file-preview {
      max-width: 100%;
      max-height: 200px;
      object-fit: contain;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fab fa-whatsapp me-2"></i>WA Multi-Phone Media
      </a>
      <div class="navbar-nav ms-auto">
        <a class="nav-link" href="account.html">
          <i class="fas fa-users me-1"></i>Manage Accounts
        </a>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="page-header mb-4">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h1 class="h4 mb-1">
            <i class="fas fa-file-upload me-2"></i>Send Media Files
          </h1>
          <p class="text-muted mb-0">Send images, videos, audio, and documents from any connected account</p>
        </div>
        <a href="index.html" class="btn btn-outline-secondary">
          <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
        </a>
      </div>
    </div>

    <!-- Account Selection -->
    <div class="row mb-4">
      <div class="col-12">
        <div class="card bg-light border">
          <div class="card-body py-3">
            <div class="row align-items-center">
              <div class="col-md-6">
                <label class="form-label mb-2">
                  <strong><i class="fas fa-mobile-alt me-2"></i>Select WhatsApp Account</strong>
                </label>
                <select class="form-select" id="phoneSelector" onchange="onAccountSelect()">
                  <option value="">Loading accounts...</option>
                </select>
              </div>
              <div class="col-md-6" id="legacyMode" style="display: none;">
                <div class="form-check form-switch mt-4">
                  <input class="form-check-input" type="checkbox" id="legacyToggle" onchange="toggleLegacyMode()">
                  <label class="form-check-label" for="legacyToggle">
                    <strong>Legacy Mode</strong>
                    <br><small class="text-muted">Use default WhatsApp connection</small>
                  </label>
                </div>
              </div>
            </div>
            <div class="alert alert-warning mt-3 mb-0" id="accountWarning" style="display: none;">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>No accounts found!</strong> Please <a href="account.html">create an account</a> or enable Legacy Mode.
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="row g-4">
      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="fas fa-upload me-2"></i>Media Upload
            </h6>
          </div>
          <div class="card-body">
            <!-- Selected Account Display -->
            <div class="mb-3" id="selectedAccountInfo" style="display: none;">
              <div class="alert alert-info">
                <strong>Sending from:</strong> <span id="selectedAccountName"></span>
                <br><small>Phone ID: <code id="selectedPhoneId"></code></small>
              </div>
            </div>

            <form id="mediaForm" class="needs-validation" novalidate enctype="multipart/form-data">
              <div class="mb-3">
                <label class="form-label">Recipient Number <span class="required">*</span></label>
                <input type="text" class="form-control" name="to" placeholder="15551234567" required />
                <div class="form-text">Include country code without + sign</div>
                <div class="invalid-feedback">Recipient required.</div>
              </div>

              <div class="mb-3">
                <label class="form-label">Media File <span class="required">*</span></label>
                <input type="file" class="form-control" name="file" accept="image/*,video/*,audio/*,application/pdf,.doc,.docx" required />
                <div class="invalid-feedback">Select a file.</div>
                <div class="form-text">
                  <i class="fas fa-info-circle me-1"></i>
                  Supported: Images, Videos, Audio, PDF, Documents (Max: 64MB)
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Caption/Message</label>
                <textarea class="form-control" name="caption" rows="3" placeholder="Optional caption or message to accompany the media"></textarea>
                <div class="form-text">Add a message to go with your media file</div>
              </div>

              <div class="mb-3 d-none" id="previewWrapper">
                <label class="form-label mb-1">File Preview</label>
                <div id="filePreview" class="border rounded p-3 bg-light">
                  <div class="text-muted small">Preview will appear here</div>
                </div>
              </div>

              <div class="d-flex align-items-center gap-2">
                <button class="btn btn-whatsapp" type="submit" id="sendBtn" disabled>
                  <i class="fas fa-paper-plane me-1"></i>Send Media
                </button>
                <div id="spinner" class="spinner-border spinner-border-sm text-success d-none" role="status"></div>
                <small class="text-muted ms-auto" id="mediaHint">Select an account first</small>
              </div>
            </form>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card h-100">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0">
              <i class="fas fa-terminal me-2"></i>Upload Progress & Response
            </h6>
          </div>
          <div class="card-body">
            <div id="uploadProgress" class="mb-3" style="display: none;">
              <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="small">Uploading...</span>
                <span id="progressPercent" class="small">0%</span>
              </div>
              <div class="progress">
                <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
              </div>
            </div>
            <pre id="result" class="small text-muted mb-0" style="white-space:pre-wrap; max-height: 400px; overflow-y: auto;">
Ready to send media files. Select an account and upload a file.
            </pre>
          </div>
        </div>
      </div>
    </div>

    <!-- File Type Guide -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-info text-white">
            <h6 class="mb-0">
              <i class="fas fa-file-alt me-2"></i>Supported File Types & Guidelines
            </h6>
          </div>
          <div class="card-body">
            <div class="row g-3">
              <div class="col-md-3">
                <div class="text-center">
                  <i class="fas fa-image fa-2x text-primary mb-2"></i>
                  <h6>Images</h6>
                  <small class="text-muted">JPG, PNG, GIF, WebP<br>Max: 64MB</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <i class="fas fa-video fa-2x text-success mb-2"></i>
                  <h6>Videos</h6>
                  <small class="text-muted">MP4, AVI, MOV, WebM<br>Max: 64MB</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <i class="fas fa-music fa-2x text-warning mb-2"></i>
                  <h6>Audio</h6>
                  <small class="text-muted">MP3, WAV, AAC, OGG<br>Max: 64MB</small>
                </div>
              </div>
              <div class="col-md-3">
                <div class="text-center">
                  <i class="fas fa-file-pdf fa-2x text-danger mb-2"></i>
                  <h6>Documents</h6>
                  <small class="text-muted">PDF, DOC, DOCX<br>Max: 64MB</small>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <script>
    let accounts = [];
    let selectedAccount = null;
    let isLegacyMode = false;

    // Load accounts on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadAccounts();
      setupFilePreview();
      setupFormValidation();
    });

    async function loadAccounts() {
      const phoneSelector = document.getElementById('phoneSelector');
      const accountWarning = document.getElementById('accountWarning');
      const legacyMode = document.getElementById('legacyMode');
      
      try {
        phoneSelector.innerHTML = '<option value="">Loading accounts...</option>';
        
        const response = await fetch('/api/accounts');
        if (response.ok) {
          const data = await response.json();
          accounts = data.accounts || data; // Handle both response formats
          
          phoneSelector.innerHTML = '<option value="">Select an account...</option>';
          
          if (accounts.length === 0) {
            phoneSelector.innerHTML = '<option value="">No accounts found</option>';
            accountWarning.style.display = 'block';
            legacyMode.style.display = 'block';
          } else {
            accounts.forEach(account => {
              const option = document.createElement('option');
              option.value = account.phone_id;
              option.textContent = `${account.name || account.phone_id} (${account.phone_id})`;
              option.setAttribute('data-token', account.token);
              option.setAttribute('data-status', account.status);
              phoneSelector.appendChild(option);
            });
            accountWarning.style.display = 'none';
            legacyMode.style.display = 'none';
          }
        } else {
          throw new Error('Failed to load accounts');
        }
      } catch (error) {
        console.error('Error loading accounts:', error);
        phoneSelector.innerHTML = '<option value="">Error loading accounts</option>';
        accountWarning.style.display = 'block';
        legacyMode.style.display = 'block';
        
        // Show legacy mode as fallback
        document.getElementById('legacyToggle').checked = true;
        toggleLegacyMode();
      }
    }

    function onAccountSelect() {
      const phoneSelector = document.getElementById('phoneSelector');
      const selectedOption = phoneSelector.options[phoneSelector.selectedIndex];
      const sendBtn = document.getElementById('sendBtn');
      const mediaHint = document.getElementById('mediaHint');
      const selectedAccountInfo = document.getElementById('selectedAccountInfo');
      const selectedAccountName = document.getElementById('selectedAccountName');
      const selectedPhoneId = document.getElementById('selectedPhoneId');
      
      if (phoneSelector.value && selectedOption.dataset.token) {
        selectedAccount = {
          phone_id: phoneSelector.value,
          token: selectedOption.dataset.token,
          name: selectedOption.textContent,
          status: selectedOption.dataset.status
        };
        
        // Show selected account info
        selectedAccountName.textContent = selectedAccount.name;
        selectedPhoneId.textContent = selectedAccount.phone_id;
        selectedAccountInfo.style.display = 'block';
        
        // Enable send button if file is also selected
        const fileInput = document.querySelector('input[name="file"]');
        if (fileInput.files.length > 0) {
          sendBtn.disabled = false;
          mediaHint.textContent = 'Ready to send';
        } else {
          sendBtn.disabled = true;
          mediaHint.textContent = 'Select a file to continue';
        }
      } else {
        selectedAccount = null;
        selectedAccountInfo.style.display = 'none';
        sendBtn.disabled = true;
        mediaHint.textContent = 'Select an account first';
      }
    }

    function toggleLegacyMode() {
      const toggle = document.getElementById('legacyToggle');
      const phoneSelector = document.getElementById('phoneSelector');
      const selectedAccountInfo = document.getElementById('selectedAccountInfo');
      const sendBtn = document.getElementById('sendBtn');
      const mediaHint = document.getElementById('mediaHint');
      
      isLegacyMode = toggle.checked;
      
      if (isLegacyMode) {
        phoneSelector.disabled = true;
        selectedAccountInfo.style.display = 'none';
        selectedAccount = null;
        
        // Enable send button if file is selected
        const fileInput = document.querySelector('input[name="file"]');
        if (fileInput.files.length > 0) {
          sendBtn.disabled = false;
          mediaHint.textContent = 'Ready to send (Legacy Mode)';
        } else {
          sendBtn.disabled = true;
          mediaHint.textContent = 'Select a file to continue (Legacy Mode)';
        }
      } else {
        phoneSelector.disabled = false;
        sendBtn.disabled = true;
        mediaHint.textContent = 'Select an account first';
        onAccountSelect();
      }
    }

    function setupFilePreview() {
      const fileInput = document.querySelector('input[name="file"]');
      const previewWrapper = document.getElementById('previewWrapper');
      const filePreview = document.getElementById('filePreview');
      const sendBtn = document.getElementById('sendBtn');
      const mediaHint = document.getElementById('mediaHint');
      
      fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        
        if (file) {
          // Check file size (64MB limit)
          const maxSize = 64 * 1024 * 1024; // 64MB in bytes
          if (file.size > maxSize) {
            alert('File size too large. Maximum allowed size is 64MB.');
            fileInput.value = '';
            previewWrapper.classList.add('d-none');
            updateSendButton();
            return;
          }
          
          // Show file info
          const fileInfo = `
            <div class="d-flex align-items-center gap-3">
              <div class="flex-shrink-0">
                <i class="fas ${getFileIcon(file.type)} fa-2x text-primary"></i>
              </div>
              <div class="flex-grow-1">
                <div class="fw-bold">${file.name}</div>
                <div class="text-muted small">
                  Type: ${file.type || 'Unknown'} | Size: ${formatFileSize(file.size)}
                </div>
              </div>
            </div>
          `;
          
          filePreview.innerHTML = fileInfo;
          previewWrapper.classList.remove('d-none');
          
          // Show image preview if it's an image
          if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
              filePreview.innerHTML += `
                <div class="mt-2">
                  <img src="${e.target.result}" class="img-fluid rounded" style="max-height: 200px;" alt="Preview">
                </div>
              `;
            };
            reader.readAsDataURL(file);
          }
        } else {
          previewWrapper.classList.add('d-none');
        }
        
        updateSendButton();
      });
    }

    function updateSendButton() {
      const fileInput = document.querySelector('input[name="file"]');
      const sendBtn = document.getElementById('sendBtn');
      const mediaHint = document.getElementById('mediaHint');
      
      const hasFile = fileInput.files.length > 0;
      const hasAccount = isLegacyMode || selectedAccount;
      
      if (hasFile && hasAccount) {
        sendBtn.disabled = false;
        mediaHint.textContent = isLegacyMode ? 'Ready to send (Legacy Mode)' : 'Ready to send';
      } else if (!hasFile) {
        sendBtn.disabled = true;
        mediaHint.textContent = 'Select a file to continue';
      } else if (!hasAccount) {
        sendBtn.disabled = true;
        mediaHint.textContent = 'Select an account first';
      }
    }

    function getFileIcon(mimeType) {
      if (mimeType.startsWith('image/')) return 'fa-image';
      if (mimeType.startsWith('video/')) return 'fa-video';
      if (mimeType.startsWith('audio/')) return 'fa-music';
      if (mimeType === 'application/pdf') return 'fa-file-pdf';
      if (mimeType.includes('document') || mimeType.includes('word')) return 'fa-file-word';
      return 'fa-file';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    function setupFormValidation() {
      const form = document.getElementById('mediaForm');
      form.addEventListener('submit', handleSubmit);
    }

    async function handleSubmit(event) {
      event.preventDefault();
      event.stopPropagation();

      const form = event.target;
      const formData = new FormData(form);
      const sendBtn = document.getElementById('sendBtn');
      const spinner = document.getElementById('spinner');
      const result = document.getElementById('result');
      const uploadProgress = document.getElementById('uploadProgress');
      const progressBar = document.getElementById('progressBar');
      const progressPercent = document.getElementById('progressPercent');

      if (!form.checkValidity()) {
        form.classList.add('was-validated');
        return;
      }

      // Validate file selection
      const fileInput = document.querySelector('input[name="file"]');
      if (!fileInput.files.length) {
        result.textContent = 'Error: Please select a file to upload.';
        result.className = 'small text-danger mb-0';
        return;
      }

      // Validate account selection (unless legacy mode)
      if (!isLegacyMode && !selectedAccount) {
        result.textContent = 'Error: Please select an account or enable legacy mode.';
        result.className = 'small text-danger mb-0';
        return;
      }

      sendBtn.disabled = true;
      spinner.classList.remove('d-none');
      uploadProgress.style.display = 'block';
      result.textContent = 'Uploading media file...';
      result.className = 'small text-info mb-0';

      try {
        const xhr = new XMLHttpRequest();
        
        // Setup progress tracking
        xhr.upload.addEventListener('progress', function(e) {
          if (e.lengthComputable) {
            const percentComplete = (e.loaded / e.total) * 100;
            progressBar.style.width = percentComplete + '%';
            progressPercent.textContent = Math.round(percentComplete) + '%';
          }
        });

        // Setup response handling
        xhr.addEventListener('load', function() {
          uploadProgress.style.display = 'none';
          
          if (xhr.status === 200) {
            const response = JSON.parse(xhr.responseText);
            result.textContent = JSON.stringify(response, null, 2);
            result.className = 'small text-success mb-0';
            
            // Reset form on success
            form.reset();
            document.getElementById('previewWrapper').classList.add('d-none');
            document.getElementById('selectedAccountInfo').style.display = 'none';
            updateSendButton();
          } else {
            const error = xhr.responseText || `HTTP ${xhr.status}`;
            result.textContent = `Error: ${error}`;
            result.className = 'small text-danger mb-0';
          }
          
          sendBtn.disabled = false;
          spinner.classList.add('d-none');
        });

        xhr.addEventListener('error', function() {
          uploadProgress.style.display = 'none';
          result.textContent = 'Error: Network error occurred during upload.';
          result.className = 'small text-danger mb-0';
          sendBtn.disabled = false;
          spinner.classList.add('d-none');
        });

        // Determine endpoint and headers
        let endpoint, headers = {};
        
        if (isLegacyMode) {
          endpoint = '/send-media';
        } else {
          endpoint = '/api/v2/send-media';
          headers['phone-id'] = selectedAccount.phone_id;
          headers['token'] = selectedAccount.token;
        }

        // Send request
        xhr.open('POST', endpoint);
        
        // Set headers
        Object.keys(headers).forEach(key => {
          xhr.setRequestHeader(key, headers[key]);
        });
        
        xhr.send(formData);

      } catch (error) {
        console.error('Error:', error);
        result.textContent = `Error: ${error.message}`;
        result.className = 'small text-danger mb-0';
        sendBtn.disabled = false;
        spinner.classList.add('d-none');
        uploadProgress.style.display = 'none';
      }
    }
  </script>
</body>
</html>
