<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Message Logs - Multi-Phone</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/styles/app.css" />
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding-bottom: 40px;
    }
    .navbar {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%) !important;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
    .container.main-container {
      background: white;
      border-radius: 20px;
      padding: 30px;
      margin-top: 20px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.2);
      max-width: 1200px;
    }
    .page-header {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 15px;
      padding: 20px 30px;
      margin-bottom: 25px;
      border-left: 5px solid #25D366;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .page-header h1 {
      margin: 0;
      font-size: 1.8rem;
    }
    .message-row {
      border-bottom: 1px solid #e9ecef;
      padding: 15px 10px;
      transition: background 0.2s ease;
    }
    .message-row:hover {
      background: #f8f9fa;
    }
    .message-row:last-child {
      border-bottom: none;
    }
    .direction-badge {
      padding: 4px 10px;
      border-radius: 15px;
      font-size: 0.75rem;
      font-weight: 600;
      display: inline-block;
      min-width: 70px;
      text-align: center;
    }
    .direction-sent { 
      background: #dcfce7; 
      color: #166534;
      border: 1px solid #86efac;
    }
    .direction-received { 
      background: #dbeafe; 
      color: #1e40af;
      border: 1px solid #93c5fd;
    }
    .message-type {
      color: #6b7280;
      font-size: 0.85rem;
    }
    .message-time {
      color: #9ca3af;
      font-size: 0.85rem;
    }
    .message-phone {
      color: #374151;
      font-weight: 500;
    }
    .message-body {
      color: #4b5563;
      margin-top: 5px;
      font-size: 0.95rem;
    }
    .loading-spinner {
      display: none;
      text-align: center;
      padding: 40px;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6c757d;
    }
    .empty-state i {
      font-size: 4rem;
      margin-bottom: 20px;
      opacity: 0.3;
    }
    .btn-refresh {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      border: none;
      color: white;
      padding: 8px 20px;
      border-radius: 8px;
      font-weight: 600;
      transition: all 0.3s ease;
    }
    .btn-refresh:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(37,211,102,0.3);
      color: white;
    }
    .table-header {
      background: #f9fafb;
      padding: 12px 10px;
      font-weight: 600;
      color: #374151;
      border-radius: 8px;
      margin-bottom: 10px;
    }
    .load-more {
      text-align: center;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fab fa-whatsapp me-2"></i>WA Automation
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html"><i class="fas fa-home me-1"></i>Home</a></li>
          <li class="nav-item"><a class="nav-link active" href="message-logs.html"><i class="fas fa-history me-1"></i>Logs</a></li>
          <li class="nav-item"><a class="nav-link" href="account.html"><i class="fas fa-users me-1"></i>Accounts</a></li>
          <li class="nav-item"><a class="nav-link" href="database.html"><i class="fas fa-database me-1"></i>Database</a></li>
        </ul>
      </div>
    </div>
  </nav>

  <div class="container main-container">
    <div class="page-header">
      <div>
        <h1><i class="fas fa-history me-3"></i>Message Logs</h1>
        <p class="text-muted small mb-0">View message history across all WhatsApp accounts</p>
      </div>
      <button class="btn btn-refresh" onclick="refreshLogs()">
        <i class="fas fa-sync me-2"></i>Refresh
      </button>
    </div>

    <!-- Account & Filter Selection -->
    <div class="row mb-4">
      <div class="col-md-6">
        <div class="card bg-light border">
          <div class="card-body py-3">
            <label class="form-label mb-2">
              <strong><i class="fas fa-mobile-alt me-2"></i>Filter by Account</strong>
            </label>
            <select class="form-select" id="phoneSelector" onchange="onAccountChange()">
              <option value="">All Accounts</option>
            </select>
          </div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card bg-light border">
          <div class="card-body py-3">
            <label class="form-label mb-2">
              <strong><i class="fas fa-filter me-2"></i>Message Type</strong>
            </label>
            <select class="form-select" id="typeFilter" onchange="refreshLogs()">
              <option value="">All Types</option>
              <option value="text">Text</option>
              <option value="image">Image</option>
              <option value="video">Video</option>
              <option value="audio">Audio</option>
              <option value="document">Document</option>
              <option value="location">Location</option>
              <option value="contact">Contact</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- Loading Spinner -->
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2">Loading messages...</p>
    </div>

    <!-- Table Header -->
    <div class="table-header d-none d-md-block">
      <div class="row">
        <div class="col-md-2">Direction</div>
        <div class="col-md-1">Type</div>
        <div class="col-md-2">Account</div>
        <div class="col-md-2">Phone</div>
        <div class="col-md-3">Message</div>
        <div class="col-md-2">Time</div>
      </div>
    </div>

    <!-- Messages Container -->
    <div id="messagesContainer"></div>

    <!-- Load More Button -->
    <div class="load-more" id="loadMoreBtn" style="display: none;">
      <button class="btn btn-refresh" onclick="loadMore()">
        <i class="fas fa-arrow-down me-2"></i>Load More
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentPage = 1;
    const pageSize = 50;
    let hasMoreMessages = true;
    let accounts = [];
    let selectedAccountId = '';

    // Load accounts and messages on page load
    document.addEventListener('DOMContentLoaded', () => {
      loadAccounts();
      loadMessages();
    });

    async function loadAccounts() {
      try {
        const response = await fetch('/api/accounts');
        if (response.ok) {
          const data = await response.json();
          accounts = data.accounts || data;
          
          const phoneSelector = document.getElementById('phoneSelector');
          phoneSelector.innerHTML = '<option value="">All Accounts</option>';
          
          accounts.forEach(account => {
            const option = document.createElement('option');
            option.value = account.phone_id;
            option.textContent = `${account.name} (${account.phone_id})`;
            phoneSelector.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading accounts:', error);
      }
    }

    function onAccountChange() {
      const phoneSelector = document.getElementById('phoneSelector');
      selectedAccountId = phoneSelector.value;
      refreshLogs();
    }

    async function loadMessages(append = false) {
      showLoading(!append);
      try {
        let url = `/api/messages/logs?page=${currentPage}&limit=${pageSize}&sort=desc`;
        
        // Add filters
        const typeFilter = document.getElementById('typeFilter').value;
        if (typeFilter) {
          url += `&type=${typeFilter}`;
        }
        
        // Note: The current API doesn't support phone_id filtering yet
        // We'll filter on the frontend for now
        
        const response = await fetch(url);
        const data = await response.json();
        
        if (data.success) {
          let messages = data.messages;
          
          // Filter by selected account (frontend filtering for now)
          if (selectedAccountId) {
            messages = messages.filter(msg => {
              // This is a simplified filter - in a real system, you'd want 
              // to store phone_id with each message in the database
              return msg.from.includes(selectedAccountId) || msg.to.includes(selectedAccountId);
            });
          }
          
          displayMessages(messages, append);
          hasMoreMessages = currentPage < data.totalPages;
          document.getElementById('loadMoreBtn').style.display = hasMoreMessages ? 'block' : 'none';
        } else {
          showError(data.error || 'Failed to load messages');
        }
      } catch (error) {
        console.error('Error loading messages:', error);
        showError('Failed to load messages. Please try again.');
      }
      showLoading(false);
    }

    function displayMessages(messages, append = false) {
      const container = document.getElementById('messagesContainer');
      
      if (messages.length === 0 && !append) {
        container.innerHTML = `
          <div class="empty-state">
            <i class="fas fa-inbox"></i>
            <h4>No Messages Found</h4>
            <p>${selectedAccountId ? 'No messages found for selected account.' : 'No messages in the database yet.'}</p>
          </div>
        `;
        return;
      }

      const html = messages.map(msg => {
        const direction = msg.fromMe ? 'sent' : 'received';
        const timestamp = new Date(msg.timestamp).toLocaleString();
        const phone = msg.fromMe ? msg.to : msg.from;
        const formattedPhone = formatPhoneNumber(phone);
        const body = msg.body ? escapeHtml(msg.body).substring(0, 80) : `[${msg.type}]`;
        
        // Try to determine which account this message belongs to
        const accountInfo = getAccountInfo(msg);
        
        return `
          <div class="message-row">
            <div class="row align-items-center">
              <div class="col-md-2 col-6 mb-2 mb-md-0">
                <span class="direction-badge direction-${direction}">
                  <i class="fas fa-${msg.fromMe ? 'arrow-up' : 'arrow-down'} me-1"></i>
                  ${msg.fromMe ? 'Sent' : 'Received'}
                </span>
              </div>
              <div class="col-md-1 col-6 mb-2 mb-md-0">
                <span class="message-type">
                  <i class="${getTypeIcon(msg.type)} me-1"></i>${msg.type}
                </span>
              </div>
              <div class="col-md-2 col-12 mb-2 mb-md-0">
                <span class="badge bg-info text-dark">
                  ${accountInfo.name || 'Unknown'}
                </span>
                <small class="text-muted d-block">${accountInfo.phone_id || 'N/A'}</small>
              </div>
              <div class="col-md-2 col-12 mb-2 mb-md-0">
                <span class="message-phone">${formattedPhone}</span>
                ${msg.isGroupMsg ? '<small class="text-muted d-block">Group</small>' : ''}
              </div>
              <div class="col-md-3 col-12 mb-2 mb-md-0">
                <div class="message-body">${body}${msg.body && msg.body.length > 80 ? '...' : ''}</div>
              </div>
              <div class="col-md-2 col-12">
                <span class="message-time">${timestamp}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      if (append) {
        container.innerHTML += html;
      } else {
        container.innerHTML = html;
      }
    }

    function getAccountInfo(message) {
      // This is a simplified approach - in a real system, you'd store the phone_id with each message
      // For now, we'll try to match based on phone numbers or return a default
      
      // Try to find matching account based on phone numbers
      const matchingAccount = accounts.find(account => {
        return message.from.includes(account.phone_id) || 
               message.to.includes(account.phone_id) ||
               (account.phone_number && (message.from.includes(account.phone_number) || message.to.includes(account.phone_number)));
      });
      
      return matchingAccount || { name: 'Unknown', phone_id: 'N/A' };
    }

    function loadMore() {
      currentPage++;
      loadMessages(true);
    }

    function refreshLogs() {
      currentPage = 1;
      hasMoreMessages = true;
      loadMessages(false);
    }

    function getTypeIcon(type) {
      const icons = {
        text: 'fas fa-comment',
        image: 'fas fa-image',
        video: 'fas fa-video',
        audio: 'fas fa-microphone',
        document: 'fas fa-file-alt',
        location: 'fas fa-map-marker-alt',
        vcard: 'fas fa-address-card',
        multi_vcard: 'fas fa-address-book',
        sticker: 'fas fa-smile',
        chat: 'fas fa-comments'
      };
      return icons[type] || 'fas fa-question';
    }

    function formatPhoneNumber(number) {
      if (!number) return 'Unknown';
      return number.replace('@c.us', '').replace('@g.us', '');
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function showLoading(show) {
      document.getElementById('loadingSpinner').style.display = show ? 'block' : 'none';
    }

    function showError(message) {
      document.getElementById('messagesContainer').innerHTML = `
        <div class="alert alert-danger" role="alert">
          <i class="fas fa-exclamation-triangle me-2"></i>${message}
        </div>
      `;
    }
  </script>
</body>
</html>
