<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Test - WhatsApp Automation</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        .test-card { margin-bottom: 1rem; }
        .test-result { font-family: monospace; font-size: 0.85rem; }
        .status-icon { width: 20px; text-align: center; }
        .navbar { background: linear-gradient(135deg, #25D366, #128C7E) !important; }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="index.html">
                <i class="fab fa-whatsapp me-2"></i>System Test
            </a>
        </div>
    </nav>

    <div class="container my-4">
        <h1 class="mb-4">
            <i class="fas fa-vial me-2"></i>
            Multi-Account System Test
        </h1>

        <div class="row">
            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-server me-2"></i>
                            API Connectivity Tests
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="apiTests">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Testing...</span>
                                </div>
                                <p class="mt-2">Running API tests...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-mobile-alt me-2"></i>
                            Account Status
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="accountTests">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Testing...</span>
                                </div>
                                <p class="mt-2">Checking accounts...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card test-card">
                    <div class="card-header">
                        <h5 class="mb-0">
                            <i class="fas fa-globe me-2"></i>
                            Page Accessibility Tests
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="pageTests">
                            <div class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Testing...</span>
                                </div>
                                <p class="mt-2">Testing page accessibility...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-chart-line me-2"></i>
                                Test Summary
                            </h5>
                            <button class="btn btn-primary btn-sm" onclick="runAllTests()">
                                <i class="fas fa-sync-alt me-1"></i>
                                Re-run Tests
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="testSummary">
                            <div class="text-center text-muted">
                                <i class="fas fa-clock fa-2x mb-3"></i>
                                <p>Tests are running... Results will appear here</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let testResults = {
            api: [],
            accounts: [],
            pages: [],
            summary: { total: 0, passed: 0, failed: 0 }
        };

        // Run all tests when page loads
        document.addEventListener('DOMContentLoaded', function() {
            runAllTests();
        });

        async function runAllTests() {
            testResults = { api: [], accounts: [], pages: [], summary: { total: 0, passed: 0, failed: 0 } };
            
            // Reset displays
            document.getElementById('apiTests').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Running API tests...</p></div>';
            document.getElementById('accountTests').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Checking accounts...</p></div>';
            document.getElementById('pageTests').innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Testing pages...</p></div>';
            document.getElementById('testSummary').innerHTML = '<div class="text-center text-muted"><div class="spinner-border" role="status"></div><p class="mt-2">Tests running...</p></div>';

            // Run tests in sequence
            await testApiEndpoints();
            await testAccountStatus();
            await testPageAccessibility();
            updateTestSummary();
        }

        async function testApiEndpoints() {
            const apiEndpoints = [
                { name: 'Account List', url: '/api/accounts', method: 'GET' },
                { name: 'Health Check', url: '/api/health', method: 'GET' },
                { name: 'Status Check', url: '/status', method: 'GET' }
            ];

            for (const endpoint of apiEndpoints) {
                try {
                    const response = await fetch(endpoint.url, { method: endpoint.method });
                    const result = {
                        name: endpoint.name,
                        url: endpoint.url,
                        status: response.status,
                        success: response.ok,
                        message: response.ok ? 'OK' : `HTTP ${response.status}`
                    };
                    testResults.api.push(result);
                } catch (error) {
                    testResults.api.push({
                        name: endpoint.name,
                        url: endpoint.url,
                        status: 0,
                        success: false,
                        message: 'Network Error: ' + error.message
                    });
                }
            }

            renderApiTests();
        }

        async function testAccountStatus() {
            try {
                const response = await fetch('/api/accounts');
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.accounts) {
                        const accounts = data.accounts;
                        testResults.accounts = accounts.map(account => ({
                            name: account.name || account.phone_id,
                            phone_id: account.phone_id,
                            status: account.status,
                            connected: account.status === 'connected',
                            phone_number: account.phone_number,
                            last_activity: account.last_activity
                        }));
                    } else {
                        testResults.accounts = [{ name: 'API Error', connected: false, message: data.message || 'Unknown error' }];
                    }
                } else {
                    testResults.accounts = [{ name: 'HTTP Error', connected: false, message: `HTTP ${response.status}` }];
                }
            } catch (error) {
                testResults.accounts = [{ name: 'Network Error', connected: false, message: error.message }];
            }

            renderAccountTests();
        }

        async function testPageAccessibility() {
            const pages = [
                { name: 'Send Message', url: 'send-message.html' },
                { name: 'Send Media', url: 'send-media.html' },
                { name: 'Send File by URL', url: 'send-file-by-url.html' },
                { name: 'Send Location', url: 'send-location.html' },
                { name: 'Send Contact', url: 'send-contact.html' },
                { name: 'Group Management', url: 'group-management.html' },
                { name: 'Message Logs', url: 'message-logs.html' },
                { name: 'Account Management', url: 'account.html' }
            ];

            for (const page of pages) {
                try {
                    const response = await fetch(page.url, { method: 'HEAD' });
                    testResults.pages.push({
                        name: page.name,
                        url: page.url,
                        accessible: response.ok,
                        status: response.status,
                        message: response.ok ? 'Accessible' : `HTTP ${response.status}`
                    });
                } catch (error) {
                    testResults.pages.push({
                        name: page.name,
                        url: page.url,
                        accessible: false,
                        status: 0,
                        message: 'Network Error'
                    });
                }
            }

            renderPageTests();
        }

        function renderApiTests() {
            const container = document.getElementById('apiTests');
            const results = testResults.api.map(test => `
                <div class="d-flex align-items-center mb-2">
                    <i class="status-icon fas ${test.success ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'}"></i>
                    <div class="flex-grow-1 ms-2">
                        <strong>${test.name}</strong>
                        <br>
                        <small class="text-muted">${test.url}</small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${test.success ? 'bg-success' : 'bg-danger'}">${test.status || 'Error'}</span>
                        <br>
                        <small class="text-muted">${test.message}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = results || '<p class="text-muted">No tests available</p>';
        }

        function renderAccountTests() {
            const container = document.getElementById('accountTests');
            if (testResults.accounts.length === 0) {
                container.innerHTML = '<p class="text-warning">No accounts found</p>';
                return;
            }

            const results = testResults.accounts.map(account => `
                <div class="d-flex align-items-center mb-2">
                    <i class="status-icon fas ${account.connected ? 'fa-check-circle text-success' : 'fa-exclamation-triangle text-warning'}"></i>
                    <div class="flex-grow-1 ms-2">
                        <strong>${account.name}</strong>
                        ${account.phone_number ? `<br><small class="text-muted">${account.phone_number}</small>` : ''}
                    </div>
                    <div class="text-end">
                        <span class="badge ${account.connected ? 'bg-success' : 'bg-warning'}">${account.status || 'Unknown'}</span>
                        ${account.message ? `<br><small class="text-muted">${account.message}</small>` : ''}
                    </div>
                </div>
            `).join('');

            container.innerHTML = results;
        }

        function renderPageTests() {
            const container = document.getElementById('pageTests');
            const results = testResults.pages.map(test => `
                <div class="d-flex align-items-center mb-2">
                    <i class="status-icon fas ${test.accessible ? 'fa-check-circle text-success' : 'fa-times-circle text-danger'}"></i>
                    <div class="flex-grow-1 ms-2">
                        <strong>${test.name}</strong>
                        <br>
                        <small class="text-muted">
                            <a href="${test.url}" target="_blank">${test.url}</a>
                        </small>
                    </div>
                    <div class="text-end">
                        <span class="badge ${test.accessible ? 'bg-success' : 'bg-danger'}">${test.status || 'Error'}</span>
                        <br>
                        <small class="text-muted">${test.message}</small>
                    </div>
                </div>
            `).join('');

            container.innerHTML = results || '<p class="text-muted">No tests available</p>';
        }

        function updateTestSummary() {
            const total = testResults.api.length + testResults.accounts.filter(a => a.name !== 'Network Error' && a.name !== 'HTTP Error' && a.name !== 'API Error').length + testResults.pages.length;
            const apiPassed = testResults.api.filter(t => t.success).length;
            const accountsPassed = testResults.accounts.filter(a => a.connected).length;
            const pagesPassed = testResults.pages.filter(t => t.accessible).length;
            const totalPassed = apiPassed + accountsPassed + pagesPassed;
            const totalFailed = total - totalPassed;

            const summaryHtml = `
                <div class="row text-center">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body">
                                <h3 class="text-primary">${total}</h3>
                                <p class="mb-0">Total Tests</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body">
                                <h3 class="text-success">${totalPassed}</h3>
                                <p class="mb-0">Passed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-danger">
                            <div class="card-body">
                                <h3 class="text-danger">${totalFailed}</h3>
                                <p class="mb-0">Failed</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body">
                                <h3 class="text-info">${total > 0 ? Math.round((totalPassed / total) * 100) : 0}%</h3>
                                <p class="mb-0">Success Rate</p>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-4">
                        <h6>API Endpoints</h6>
                        <p class="mb-0">${apiPassed} / ${testResults.api.length} passed</p>
                    </div>
                    <div class="col-md-4">
                        <h6>WhatsApp Accounts</h6>
                        <p class="mb-0">${accountsPassed} / ${testResults.accounts.filter(a => a.name !== 'Network Error' && a.name !== 'HTTP Error' && a.name !== 'API Error').length} connected</p>
                    </div>
                    <div class="col-md-4">
                        <h6>Pages</h6>
                        <p class="mb-0">${pagesPassed} / ${testResults.pages.length} accessible</p>
                    </div>
                </div>
                <div class="mt-3">
                    <small class="text-muted">
                        <i class="fas fa-clock me-1"></i>
                        Last tested: ${new Date().toLocaleString()}
                    </small>
                </div>
            `;

            document.getElementById('testSummary').innerHTML = summaryHtml;
        }
    </script>
</body>
</html>