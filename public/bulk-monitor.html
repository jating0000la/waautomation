<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campaign Monitor - WhatsApp Bulk Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 0.5rem;
        }
        .status-running { background: #28a745; }
        .status-paused { background: #ffc107; }
        .status-completed { background: #6c757d; }
        .status-failed { background: #dc3545; }
        .status-scheduled { background: #007bff; }
        .real-time-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .progress-custom {
            height: 25px;
            border-radius: 12px;
        }
        .campaign-card {
            transition: all 0.3s ease;
        }
        .campaign-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="bulk-dashboard.html">
                <i class="fab fa-whatsapp me-2"></i>
                Campaign Monitor
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="bulk-dashboard.html">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">Campaign Monitor</h1>
                        <p class="text-muted">Real-time monitoring and analytics for your campaigns</p>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" onclick="refreshData()">
                            <i class="fas fa-sync-alt me-2"></i>Refresh
                        </button>
                        <span class="badge bg-secondary" id="lastUpdated">Never</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Statistics -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card real-time-stats">
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-play-circle fa-2x"></i>
                                </div>
                                <h4 id="activeCount">-</h4>
                                <small>Active Campaigns</small>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-paper-plane fa-2x"></i>
                                </div>
                                <h4 id="sentToday">-</h4>
                                <small>Messages Sent Today</small>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-chart-line fa-2x"></i>
                                </div>
                                <h4 id="successRate">-</h4>
                                <small>Success Rate</small>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-2">
                                    <i class="fas fa-shield-alt fa-2x"></i>
                                </div>
                                <h4 id="riskLevel">-</h4>
                                <small>Risk Level</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Campaign Status Cards -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Active Campaigns</h5>
                            <div>
                                <select class="form-select form-select-sm" id="statusFilter">
                                    <option value="">All Status</option>
                                    <option value="running">Running</option>
                                    <option value="paused">Paused</option>
                                    <option value="scheduled">Scheduled</option>
                                    <option value="completed">Completed</option>
                                    <option value="failed">Failed</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="campaignsList">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading campaigns...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Analytics -->
        <div class="row">
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Message Delivery Chart</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="deliveryChart" height="200"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-md-6 mb-4">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Campaign Performance</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="performanceChart" height="200"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- System Health -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">System Health & Throttling</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4">
                                <h6>Today's Usage</h6>
                                <div class="mb-2">
                                    <small>Daily Limit Progress</small>
                                    <div class="progress progress-custom">
                                        <div class="progress-bar" id="dailyProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="dailyUsage">0 / 1000 messages</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Current Hour Usage</h6>
                                <div class="mb-2">
                                    <small>Hourly Limit Progress</small>
                                    <div class="progress progress-custom">
                                        <div class="progress-bar bg-warning" id="hourlyProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="hourlyUsage">0 / 300 messages</small>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <h6>Current Minute Usage</h6>
                                <div class="mb-2">
                                    <small>Per-minute Limit Progress</small>
                                    <div class="progress progress-custom">
                                        <div class="progress-bar bg-info" id="minuteProgress" style="width: 0%"></div>
                                    </div>
                                    <small class="text-muted" id="minuteUsage">0 / 10 messages</small>
                                </div>
                            </div>
                        </div>
                        <div class="row mt-3">
                            <div class="col-12">
                                <div id="banRiskAlert" class="alert" style="display: none;">
                                    <h6 class="alert-heading">Ban Risk Assessment</h6>
                                    <div id="riskDetails"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Campaign Details Modal -->
    <div class="modal fade" id="campaignModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="campaignModalTitle">Campaign Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="campaignDetails">
                        <!-- Campaign details will be loaded here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <div id="campaignActions">
                        <!-- Action buttons will be added here -->
                    </div>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let campaigns = [];
        let systemStatus = {};
        let deliveryChart = null;
        let performanceChart = null;

        // Auto-refresh interval
        setInterval(refreshData, 30000); // Refresh every 30 seconds

        // Load all data
        async function refreshData() {
            await Promise.all([
                loadSystemStatus(),
                loadCampaigns(),
                updateCharts()
            ]);
            
            document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/bulk/status');
                systemStatus = await response.json();
                
                updateSystemStats();
                updateThrottlingInfo();
                updateBanRisk();
            } catch (error) {
                console.error('Error loading system status:', error);
            }
        }

        function updateSystemStats() {
            const activeCampaigns = Object.keys(systemStatus.activeCampaigns || {}).length;
            document.getElementById('activeCount').textContent = activeCampaigns;
            
            const sentToday = systemStatus.throttling?.stats?.sentToday || 0;
            document.getElementById('sentToday').textContent = sentToday;
            
            // Calculate success rate (placeholder)
            document.getElementById('successRate').textContent = '95%';
            
            const riskLevel = systemStatus.banRisk?.riskLevel || 'low';
            document.getElementById('riskLevel').textContent = riskLevel.toUpperCase();
            document.getElementById('riskLevel').className = `text-${getRiskColor(riskLevel)}`;
        }

        function updateThrottlingInfo() {
            const stats = systemStatus.throttling?.stats || {};
            
            // Daily usage
            const dailyUsed = stats.sentToday || 0;
            const dailyLimit = 1000; // Default limit
            const dailyPercent = Math.min((dailyUsed / dailyLimit) * 100, 100);
            
            document.getElementById('dailyProgress').style.width = dailyPercent + '%';
            document.getElementById('dailyProgress').className = 
                `progress-bar ${dailyPercent > 80 ? 'bg-danger' : dailyPercent > 60 ? 'bg-warning' : 'bg-success'}`;
            document.getElementById('dailyUsage').textContent = `${dailyUsed} / ${dailyLimit} messages`;
            
            // Hourly usage
            const hourlyUsed = stats.sentThisHour || 0;
            const hourlyLimit = 300;
            const hourlyPercent = Math.min((hourlyUsed / hourlyLimit) * 100, 100);
            
            document.getElementById('hourlyProgress').style.width = hourlyPercent + '%';
            document.getElementById('hourlyUsage').textContent = `${hourlyUsed} / ${hourlyLimit} messages`;
            
            // Minute usage
            const minuteUsed = stats.sentThisMinute || 0;
            const minuteLimit = 10;
            const minutePercent = Math.min((minuteUsed / minuteLimit) * 100, 100);
            
            document.getElementById('minuteProgress').style.width = minutePercent + '%';
            document.getElementById('minuteUsage').textContent = `${minuteUsed} / ${minuteLimit} messages`;
        }

        function updateBanRisk() {
            const banRisk = systemStatus.banRisk || {};
            const alertDiv = document.getElementById('banRiskAlert');
            const detailsDiv = document.getElementById('riskDetails');
            
            if (banRisk.riskLevel && banRisk.riskLevel !== 'low') {
                alertDiv.style.display = 'block';
                alertDiv.className = `alert alert-${getRiskColor(banRisk.riskLevel)}`;
                
                detailsDiv.innerHTML = `
                    <p><strong>Risk Level:</strong> ${banRisk.riskLevel.toUpperCase()}</p>
                    <p><strong>Health Score:</strong> ${banRisk.healthScore}%</p>
                    <p><strong>Daily Usage:</strong> ${banRisk.dailyUsage}%</p>
                    <p><strong>Hourly Usage:</strong> ${banRisk.hourlyUsage}%</p>
                    ${banRisk.recommendations.length > 0 ? 
                        `<p><strong>Recommendations:</strong></p><ul>${banRisk.recommendations.map(r => `<li>${r}</li>`).join('')}</ul>` 
                        : ''}
                `;
            } else {
                alertDiv.style.display = 'none';
            }
        }

        // Load campaigns
        async function loadCampaigns() {
            try {
                const statusFilter = document.getElementById('statusFilter').value;
                let url = '/api/bulk/campaigns?limit=20';
                if (statusFilter) url += `&status=${statusFilter}`;
                
                const response = await fetch(url);
                const data = await response.json();
                campaigns = data.campaigns || [];
                
                renderCampaigns();
            } catch (error) {
                console.error('Error loading campaigns:', error);
                document.getElementById('campaignsList').innerHTML = 
                    '<div class="alert alert-danger">Error loading campaigns</div>';
            }
        }

        function renderCampaigns() {
            const listDiv = document.getElementById('campaignsList');
            
            if (campaigns.length === 0) {
                listDiv.textContent = 'No campaigns found';
                listDiv.className = 'text-center text-muted';
                return;
            }

            // Clear existing content
            listDiv.innerHTML = '';
            
            campaigns.forEach(campaign => {
                const scheduler = systemStatus.activeCampaigns?.[campaign.id];
                const progress = scheduler ? parseFloat(scheduler.progress) : 0;
                
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card campaign-card mb-3';
                
                const cardBody = document.createElement('div');
                cardBody.className = 'card-body';
                
                const row = document.createElement('div');
                row.className = 'row align-items-center';
                
                // Column 1: Campaign name and template
                const col1 = document.createElement('div');
                col1.className = 'col-md-4';
                
                const flexDiv = document.createElement('div');
                flexDiv.className = 'd-flex align-items-center';
                
                const statusIndicator = document.createElement('div');
                statusIndicator.className = `status-indicator status-${campaign.status}`;
                flexDiv.appendChild(statusIndicator);
                
                const infoDiv = document.createElement('div');
                
                const nameH6 = document.createElement('h6');
                nameH6.className = 'mb-1';
                nameH6.textContent = campaign.name;
                infoDiv.appendChild(nameH6);
                
                const templateSmall = document.createElement('small');
                templateSmall.className = 'text-muted';
                templateSmall.textContent = campaign.template?.name || 'Unknown Template';
                infoDiv.appendChild(templateSmall);
                
                flexDiv.appendChild(infoDiv);
                col1.appendChild(flexDiv);
                row.appendChild(col1);
                
                // Column 2: Progress bar
                const col2 = document.createElement('div');
                col2.className = 'col-md-3';
                
                const progressDiv = document.createElement('div');
                progressDiv.className = 'progress progress-custom mb-1';
                
                const progressBar = document.createElement('div');
                progressBar.className = 'progress-bar';
                progressBar.style.width = `${progress}%`;
                progressDiv.appendChild(progressBar);
                col2.appendChild(progressDiv);
                
                const progressText = document.createElement('small');
                progressText.className = 'text-muted';
                progressText.textContent = `${progress.toFixed(1)}% Complete`;
                col2.appendChild(progressText);
                row.appendChild(col2);
                
                // Column 3: Sent count
                const col3 = document.createElement('div');
                col3.className = 'col-md-2';
                
                const sentDiv = document.createElement('div');
                sentDiv.className = 'text-center';
                
                const sentCount = document.createElement('div');
                sentCount.className = 'fw-bold';
                sentCount.textContent = scheduler?.stats?.sent || 0;
                sentDiv.appendChild(sentCount);
                
                const sentLabel = document.createElement('small');
                sentLabel.className = 'text-muted';
                sentLabel.textContent = 'Sent';
                sentDiv.appendChild(sentLabel);
                
                col3.appendChild(sentDiv);
                row.appendChild(col3);
                
                // Column 4: Failed count
                const col4 = document.createElement('div');
                col4.className = 'col-md-2';
                
                const failedDiv = document.createElement('div');
                failedDiv.className = 'text-center';
                
                const failedCount = document.createElement('div');
                failedCount.className = 'fw-bold text-danger';
                failedCount.textContent = scheduler?.stats?.failed || 0;
                failedDiv.appendChild(failedCount);
                
                const failedLabel = document.createElement('small');
                failedLabel.className = 'text-muted';
                failedLabel.textContent = 'Failed';
                failedDiv.appendChild(failedLabel);
                
                col4.appendChild(failedDiv);
                row.appendChild(col4);
                
                // Column 5: Details button
                const col5 = document.createElement('div');
                col5.className = 'col-md-1 text-end';
                
                const detailsBtn = document.createElement('button');
                detailsBtn.className = 'btn btn-sm btn-outline-primary';
                detailsBtn.onclick = () => showCampaignDetails(campaign.id);
                
                const icon = document.createElement('i');
                icon.className = 'fas fa-eye';
                detailsBtn.appendChild(icon);
                
                col5.appendChild(detailsBtn);
                row.appendChild(col5);
                
                cardBody.appendChild(row);
                cardDiv.appendChild(cardBody);
                listDiv.appendChild(cardDiv);
            });
        }

        // Show campaign details modal
        async function showCampaignDetails(campaignId) {
            try {
                const response = await fetch(`/api/bulk/campaigns/${campaignId}/stats`);
                const data = await response.json();
                
                document.getElementById('campaignModalTitle').textContent = data.campaign.name;
                
                const detailsDiv = document.getElementById('campaignDetails');
                detailsDiv.innerHTML = ''; // Clear first
                
                // Create row container
                const row = document.createElement('div');
                row.className = 'row';
                
                // Left column - Campaign Information
                const col1 = document.createElement('div');
                col1.className = 'col-md-6';
                
                const infoHeading = document.createElement('h6');
                infoHeading.textContent = 'Campaign Information';
                col1.appendChild(infoHeading);
                
                const table = document.createElement('table');
                table.className = 'table table-sm';
                
                // Status row
                const statusRow = table.insertRow();
                const statusLabel = statusRow.insertCell();
                statusLabel.innerHTML = '<strong>Status:</strong>';
                const statusValue = statusRow.insertCell();
                const statusBadge = document.createElement('span');
                statusBadge.className = `badge bg-${getStatusColor(data.campaign.status)}`;
                statusBadge.textContent = data.campaign.status;
                statusValue.appendChild(statusBadge);
                
                // Created row
                const createdRow = table.insertRow();
                createdRow.insertCell().innerHTML = '<strong>Created:</strong>';
                createdRow.insertCell().textContent = new Date(data.campaign.createdAt).toLocaleString();
                
                // Started row (if exists)
                if (data.campaign.startedAt) {
                    const startedRow = table.insertRow();
                    startedRow.insertCell().innerHTML = '<strong>Started:</strong>';
                    startedRow.insertCell().textContent = new Date(data.campaign.startedAt).toLocaleString();
                }
                
                // Completed row (if exists)
                if (data.campaign.completedAt) {
                    const completedRow = table.insertRow();
                    completedRow.insertCell().innerHTML = '<strong>Completed:</strong>';
                    completedRow.insertCell().textContent = new Date(data.campaign.completedAt).toLocaleString();
                }
                
                col1.appendChild(table);
                row.appendChild(col1);
                
                // Right column - Delivery Statistics
                const col2 = document.createElement('div');
                col2.className = 'col-md-6';
                
                const statsHeading = document.createElement('h6');
                statsHeading.textContent = 'Delivery Statistics';
                col2.appendChild(statsHeading);
                
                const statsDiv = document.createElement('div');
                statsDiv.className = 'text-center';
                
                Object.entries(data.sends).forEach(([status, count]) => {
                    const statBlock = document.createElement('div');
                    statBlock.className = 'd-inline-block mx-3';
                    
                    const countDiv = document.createElement('div');
                    countDiv.className = `h4 text-${getStatusColor(status)}`;
                    countDiv.textContent = count;
                    statBlock.appendChild(countDiv);
                    
                    const labelDiv = document.createElement('div');
                    labelDiv.className = 'small text-muted';
                    labelDiv.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    statBlock.appendChild(labelDiv);
                    
                    statsDiv.appendChild(statBlock);
                });
                
                col2.appendChild(statsDiv);
                row.appendChild(col2);
                
                detailsDiv.appendChild(row);
                
                // Real-time progress section (if scheduler data exists)
                if (data.scheduler) {
                    const hr = document.createElement('hr');
                    detailsDiv.appendChild(hr);
                    
                    const progressRow = document.createElement('div');
                    progressRow.className = 'row';
                    
                    const progressCol = document.createElement('div');
                    progressCol.className = 'col-12';
                    
                    const progressHeading = document.createElement('h6');
                    progressHeading.textContent = 'Real-time Progress';
                    progressCol.appendChild(progressHeading);
                    
                    const progressBarDiv = document.createElement('div');
                    progressBarDiv.className = 'progress progress-custom mb-2';
                    
                    const progressBar = document.createElement('div');
                    progressBar.className = 'progress-bar';
                    progressBar.style.width = `${data.scheduler.progress}%`;
                    progressBarDiv.appendChild(progressBar);
                    progressCol.appendChild(progressBarDiv);
                    
                    const metricsRow = document.createElement('div');
                    metricsRow.className = 'row text-center';
                    
                    const metrics = [
                        { label: 'Current', value: data.scheduler.currentIndex },
                        { label: 'Total', value: data.scheduler.totalMessages },
                        { label: 'Remaining', value: data.scheduler.stats.remaining },
                        { label: 'ETA', value: data.scheduler.stats.estimatedCompletion ? 
                            new Date(data.scheduler.stats.estimatedCompletion).toLocaleTimeString() : 'N/A' }
                    ];
                    
                    metrics.forEach(metric => {
                        const metricCol = document.createElement('div');
                        metricCol.className = 'col-3';
                        
                        const valueDiv = document.createElement('div');
                        valueDiv.className = 'fw-bold';
                        valueDiv.textContent = metric.value;
                        metricCol.appendChild(valueDiv);
                        
                        const labelSmall = document.createElement('small');
                        labelSmall.className = 'text-muted';
                        labelSmall.textContent = metric.label;
                        metricCol.appendChild(labelSmall);
                        
                        metricsRow.appendChild(metricCol);
                    });
                    
                    progressCol.appendChild(metricsRow);
                    progressRow.appendChild(progressCol);
                    detailsDiv.appendChild(progressRow);
                }
                
                // Add action buttons
                const actionsDiv = document.getElementById('campaignActions');
                actionsDiv.innerHTML = '';
                
                if (data.campaign.status === 'running') {
                    const pauseBtn = document.createElement('button');
                    pauseBtn.className = 'btn btn-warning me-2';
                    pauseBtn.onclick = () => pauseCampaign(campaignId);
                    pauseBtn.innerHTML = '<i class="fas fa-pause"></i> Pause';
                    actionsDiv.appendChild(pauseBtn);
                    
                    const stopBtn = document.createElement('button');
                    stopBtn.className = 'btn btn-danger me-2';
                    stopBtn.onclick = () => stopCampaign(campaignId);
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                    actionsDiv.appendChild(stopBtn);
                } else if (data.campaign.status === 'paused') {
                    const resumeBtn = document.createElement('button');
                    resumeBtn.className = 'btn btn-success me-2';
                    resumeBtn.onclick = () => resumeCampaign(campaignId);
                    resumeBtn.innerHTML = '<i class="fas fa-play"></i> Resume';
                    actionsDiv.appendChild(resumeBtn);
                    
                    const stopBtn = document.createElement('button');
                    stopBtn.className = 'btn btn-danger me-2';
                    stopBtn.onclick = () => stopCampaign(campaignId);
                    stopBtn.innerHTML = '<i class="fas fa-stop"></i> Stop';
                    actionsDiv.appendChild(stopBtn);
                } else if (['draft', 'scheduled'].includes(data.campaign.status)) {
                    const startBtn = document.createElement('button');
                    startBtn.className = 'btn btn-success me-2';
                    startBtn.onclick = () => startCampaign(campaignId);
                    startBtn.innerHTML = '<i class="fas fa-play"></i> Start';
                    actionsDiv.appendChild(startBtn);
                }
                
                new bootstrap.Modal(document.getElementById('campaignModal')).show();
            } catch (error) {
                alert('Error loading campaign details');
            }
        }

        // Campaign control functions
        async function startCampaign(campaignId) {
            await campaignAction(campaignId, 'start', 'Campaign started successfully');
        }

        async function pauseCampaign(campaignId) {
            await campaignAction(campaignId, 'pause', 'Campaign paused successfully');
        }

        async function resumeCampaign(campaignId) {
            await campaignAction(campaignId, 'resume', 'Campaign resumed successfully');
        }

        async function stopCampaign(campaignId) {
            if (!confirm('Are you sure you want to stop this campaign?')) return;
            await campaignAction(campaignId, 'stop', 'Campaign stopped successfully');
        }

        async function campaignAction(campaignId, action, successMessage) {
            try {
                const response = await fetch(`/api/bulk/campaigns/${campaignId}/${action}`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert(successMessage);
                    bootstrap.Modal.getInstance(document.getElementById('campaignModal')).hide();
                    refreshData();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error(`Error ${action} campaign:`, error);
                alert(`Error ${action} campaign`);
            }
        }

        // Initialize charts
        function updateCharts() {
            updateDeliveryChart();
            updatePerformanceChart();
        }

        function updateDeliveryChart() {
            const ctx = document.getElementById('deliveryChart').getContext('2d');
            
            if (deliveryChart) {
                deliveryChart.destroy();
            }

            // Sample data - in real implementation, fetch from API
            deliveryChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['6h ago', '5h ago', '4h ago', '3h ago', '2h ago', '1h ago', 'Now'],
                    datasets: [{
                        label: 'Messages Sent',
                        data: [45, 78, 123, 89, 156, 134, 98],
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        function updatePerformanceChart() {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            
            if (performanceChart) {
                performanceChart.destroy();
            }

            // Sample data
            performanceChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Sent', 'Failed', 'Pending'],
                    datasets: [{
                        data: [850, 45, 105],
                        backgroundColor: [
                            'rgb(75, 192, 192)',
                            'rgb(255, 99, 132)',
                            'rgb(255, 205, 86)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        // Utility functions
        function getStatusColor(status) {
            switch(status) {
                case 'running': return 'success';
                case 'scheduled': return 'info';
                case 'paused': return 'warning';
                case 'completed': return 'secondary';
                case 'failed': return 'danger';
                case 'sent': return 'success';
                case 'pending': return 'warning';
                default: return 'primary';
            }
        }

        function getRiskColor(level) {
            switch(level) {
                case 'high': return 'danger';
                case 'medium': return 'warning';
                default: return 'success';
            }
        }

        // Event listeners
        document.getElementById('statusFilter').addEventListener('change', loadCampaigns);

        // Initial load
        refreshData();
    </script>
</body>
</html>
