<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Settings - WhatsApp Bulk Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .setting-section {
            border-bottom: 1px solid #dee2e6;
            padding-bottom: 1.5rem;
            margin-bottom: 1.5rem;
        }
        .setting-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .form-switch {
            padding-left: 2.5em;
        }
        .form-switch .form-check-input {
            width: 2em;
            margin-left: -2.5em;
        }
        .text-danger { color: #dc3545 !important; }
        .text-warning { color: #ffc107 !important; }
        .text-success { color: #198754 !important; }
        .alert-custom {
            border-left: 4px solid;
            border-radius: 0;
        }
        .alert-info-custom { border-color: #0dcaf0; }
        .alert-warning-custom { border-color: #ffc107; }
        .alert-danger-custom { border-color: #dc3545; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="bulk-dashboard.html">
                <i class="fas fa-cog me-2"></i>
                System Settings
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="bulk-dashboard.html">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">System Settings</h1>
                        <p class="text-muted">Configure system-wide settings for bulk messaging</p>
                    </div>
                    <div>
                        <button class="btn btn-success" onclick="saveAllSettings()">
                            <i class="fas fa-save me-2"></i>Save All Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Main Settings Panel -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-body">
                        <!-- Throttling Settings -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-tachometer-alt text-primary me-2"></i>
                                Message Throttling
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Messages per Minute</label>
                                    <input type="number" class="form-control" id="messagesPerMinute" min="1" max="30" value="10">
                                    <small class="form-text text-muted">Max: 30 messages</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Messages per Hour</label>
                                    <input type="number" class="form-control" id="messagesPerHour" min="1" max="500" value="300">
                                    <small class="form-text text-muted">Max: 500 messages</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Messages per Day</label>
                                    <input type="number" class="form-control" id="messagesPerDay" min="1" max="2000" value="1000">
                                    <small class="form-text text-muted">Max: 2000 messages</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Delay Between Messages (seconds)</label>
                                    <input type="number" class="form-control" id="messageDelay" min="1" max="60" value="6">
                                    <small class="form-text text-muted">Recommended: 3-10 seconds</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Random Delay Variance (%)</label>
                                    <input type="range" class="form-range" id="delayVariance" min="0" max="50" value="20">
                                    <div class="d-flex justify-content-between">
                                        <small>0%</small>
                                        <small id="delayVarianceValue">20%</small>
                                        <small>50%</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Ban Prevention Settings -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-shield-alt text-warning me-2"></i>
                                Ban Prevention
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableBanPrevention" checked>
                                        <label class="form-check-label" for="enableBanPrevention">
                                            Enable Ban Prevention
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Automatically adjust sending patterns to avoid bans</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableWarmupMode" checked>
                                        <label class="form-check-label" for="enableWarmupMode">
                                            Enable Warm-up Mode
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Gradually increase message volume for new accounts</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Daily Increase Rate (%)</label>
                                    <input type="number" class="form-control" id="warmupIncreaseRate" min="5" max="50" value="20">
                                    <small class="form-text text-muted">Daily volume increase during warm-up</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Warm-up Duration (days)</label>
                                    <input type="number" class="form-control" id="warmupDuration" min="1" max="30" value="7">
                                    <small class="form-text text-muted">How long to run warm-up mode</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Starting Volume (%)</label>
                                    <input type="number" class="form-control" id="warmupStartVolume" min="5" max="50" value="10">
                                    <small class="form-text text-muted">Initial percentage of full capacity</small>
                                </div>
                            </div>
                        </div>

                        <!-- Working Hours -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-clock text-info me-2"></i>
                                Working Hours
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableWorkingHours" checked>
                                        <label class="form-check-label" for="enableWorkingHours">
                                            Restrict to Working Hours
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Only send messages during specified hours</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableTimeZoneDetection">
                                        <label class="form-check-label" for="enableTimeZoneDetection">
                                            Auto Timezone Detection
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Detect recipient timezone from phone number</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">Start Time</label>
                                    <input type="time" class="form-control" id="workingHoursStart" value="09:00">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label class="form-label">End Time</label>
                                    <input type="time" class="form-control" id="workingHoursEnd" value="18:00">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Working Days</label>
                                    <div class="row">
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workMon" checked>
                                                <label class="form-check-label" for="workMon">Monday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workTue" checked>
                                                <label class="form-check-label" for="workTue">Tuesday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workWed" checked>
                                                <label class="form-check-label" for="workWed">Wednesday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workThu" checked>
                                                <label class="form-check-label" for="workThu">Thursday</label>
                                            </div>
                                        </div>
                                        <div class="col-6">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workFri" checked>
                                                <label class="form-check-label" for="workFri">Friday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workSat">
                                                <label class="form-check-label" for="workSat">Saturday</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="workSun">
                                                <label class="form-check-label" for="workSun">Sunday</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Retry Settings -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-redo text-secondary me-2"></i>
                                Retry Settings
                            </h5>
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Max Retry Attempts</label>
                                    <input type="number" class="form-control" id="maxRetries" min="0" max="5" value="3">
                                    <small class="form-text text-muted">Number of retry attempts for failed messages</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Retry Delay (minutes)</label>
                                    <input type="number" class="form-control" id="retryDelay" min="1" max="60" value="15">
                                    <small class="form-text text-muted">Wait time before retrying</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Backoff Multiplier</label>
                                    <input type="number" class="form-control" id="backoffMultiplier" min="1" max="5" step="0.1" value="2">
                                    <small class="form-text text-muted">Increase delay by this factor each retry</small>
                                </div>
                            </div>
                        </div>

                        <!-- Webhook Settings -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-webhook text-success me-2"></i>
                                Webhook Configuration
                            </h5>
                            <div class="row">
                                <div class="col-md-8 mb-3">
                                    <label class="form-label">Webhook URL</label>
                                    <input type="url" class="form-control" id="webhookUrl" placeholder="https://your-server.com/webhook">
                                    <small class="form-text text-muted">URL to receive status updates</small>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">Webhook Secret</label>
                                    <input type="password" class="form-control" id="webhookSecret">
                                    <small class="form-text text-muted">Secret for webhook verification</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12">
                                    <label class="form-label">Webhook Events</label>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="webhookMessageSent" checked>
                                                <label class="form-check-label" for="webhookMessageSent">Message Sent</label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="webhookMessageFailed" checked>
                                                <label class="form-check-label" for="webhookMessageFailed">Message Failed</label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="webhookCampaignStart" checked>
                                                <label class="form-check-label" for="webhookCampaignStart">Campaign Started</label>
                                            </div>
                                        </div>
                                        <div class="col-md-3">
                                            <div class="form-check">
                                                <input class="form-check-input" type="checkbox" id="webhookCampaignComplete" checked>
                                                <label class="form-check-label" for="webhookCampaignComplete">Campaign Completed</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Debug Settings -->
                        <div class="setting-section">
                            <h5 class="mb-3">
                                <i class="fas fa-bug text-danger me-2"></i>
                                Debug & Logging
                            </h5>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Log Level</label>
                                    <select class="form-select" id="logLevel">
                                        <option value="error">Error</option>
                                        <option value="warn">Warning</option>
                                        <option value="info" selected>Info</option>
                                        <option value="debug">Debug</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Log Retention (days)</label>
                                    <input type="number" class="form-control" id="logRetention" min="1" max="365" value="30">
                                    <small class="form-text text-muted">How long to keep log files</small>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableDebugMode">
                                        <label class="form-check-label" for="enableDebugMode">
                                            Enable Debug Mode
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Enable detailed logging and debugging</small>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input" type="checkbox" id="enableTestMode">
                                        <label class="form-check-label" for="enableTestMode">
                                            Enable Test Mode
                                        </label>
                                    </div>
                                    <small class="form-text text-muted">Simulate sending without actual messages</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Status Panel -->
            <div class="col-lg-4">
                <!-- System Status -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">System Status</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>WhatsApp Connection</span>
                            <span class="badge bg-success" id="whatsappStatus">Connected</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Database</span>
                            <span class="badge bg-success" id="databaseStatus">Connected</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>Active Campaigns</span>
                            <span class="badge bg-info" id="activeCampaigns">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span>Messages Today</span>
                            <span class="badge bg-primary" id="messagesToday">0</span>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Recent Settings Changes</h6>
                    </div>
                    <div class="card-body">
                        <div id="recentActivity">
                            <div class="text-center text-muted">
                                <i class="fas fa-clock"></i>
                                <br>
                                No recent changes
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quick Actions -->
                <div class="card">
                    <div class="card-header">
                        <h6 class="card-title mb-0">Quick Actions</h6>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-outline-primary" onclick="resetToDefaults()">
                                <i class="fas fa-undo me-2"></i>Reset to Defaults
                            </button>
                            <button class="btn btn-outline-success" onclick="testWebhook()">
                                <i class="fas fa-test-tube me-2"></i>Test Webhook
                            </button>
                            <button class="btn btn-outline-warning" onclick="pauseAllCampaigns()">
                                <i class="fas fa-pause me-2"></i>Pause All Campaigns
                            </button>
                            <button class="btn btn-outline-info" onclick="exportSettings()">
                                <i class="fas fa-download me-2"></i>Export Settings
                            </button>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importSettings(event)">
                            <button class="btn btn-outline-secondary" onclick="document.getElementById('importFile').click()">
                                <i class="fas fa-upload me-2"></i>Import Settings
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        let currentSettings = {};

        // Load settings on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadCurrentSettings();
            loadSystemStatus();
            
            // Add event listeners for real-time validation
            document.getElementById('delayVariance').addEventListener('input', updateDelayVarianceDisplay);
        });

        // Load current settings from server
        async function loadCurrentSettings() {
            try {
                const response = await fetch('/api/bulk/settings');
                currentSettings = await response.json();
                populateForm(currentSettings);
            } catch (error) {
                console.error('Error loading settings:', error);
                showAlert('Error loading current settings', 'danger');
            }
        }

        // Populate form with current settings
        function populateForm(settings) {
            // Throttling settings
            document.getElementById('messagesPerMinute').value = settings.throttling?.messagesPerMinute || 10;
            document.getElementById('messagesPerHour').value = settings.throttling?.messagesPerHour || 300;
            document.getElementById('messagesPerDay').value = settings.throttling?.messagesPerDay || 1000;
            document.getElementById('messageDelay').value = settings.throttling?.messageDelay || 6;
            document.getElementById('delayVariance').value = settings.throttling?.delayVariance || 20;
            updateDelayVarianceDisplay();

            // Ban prevention
            document.getElementById('enableBanPrevention').checked = settings.banPrevention?.enabled !== false;
            document.getElementById('enableWarmupMode').checked = settings.banPrevention?.warmupMode !== false;
            document.getElementById('warmupIncreaseRate').value = settings.banPrevention?.warmupIncreaseRate || 20;
            document.getElementById('warmupDuration').value = settings.banPrevention?.warmupDuration || 7;
            document.getElementById('warmupStartVolume').value = settings.banPrevention?.warmupStartVolume || 10;

            // Working hours
            document.getElementById('enableWorkingHours').checked = settings.workingHours?.enabled !== false;
            document.getElementById('enableTimeZoneDetection').checked = settings.workingHours?.timezoneDetection || false;
            document.getElementById('workingHoursStart').value = settings.workingHours?.startTime || '09:00';
            document.getElementById('workingHoursEnd').value = settings.workingHours?.endTime || '18:00';
            
            const workingDays = settings.workingHours?.workingDays || ['monday', 'tuesday', 'wednesday', 'thursday', 'friday'];
            ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].forEach(day => {
                const checkbox = document.getElementById(`work${day.charAt(0).toUpperCase() + day.slice(1, 3)}`);
                if (checkbox) checkbox.checked = workingDays.includes(day);
            });

            // Retry settings
            document.getElementById('maxRetries').value = settings.retry?.maxAttempts || 3;
            document.getElementById('retryDelay').value = settings.retry?.delayMinutes || 15;
            document.getElementById('backoffMultiplier').value = settings.retry?.backoffMultiplier || 2;

            // Webhook settings
            document.getElementById('webhookUrl').value = settings.webhook?.url || '';
            document.getElementById('webhookSecret').value = settings.webhook?.secret || '';
            
            const webhookEvents = settings.webhook?.events || ['messageSent', 'messageFailed', 'campaignStart', 'campaignComplete'];
            ['messageSent', 'messageFailed', 'campaignStart', 'campaignComplete'].forEach(event => {
                const checkbox = document.getElementById(`webhook${event.charAt(0).toUpperCase() + event.slice(1)}`);
                if (checkbox) checkbox.checked = webhookEvents.includes(event);
            });

            // Debug settings
            document.getElementById('logLevel').value = settings.debug?.logLevel || 'info';
            document.getElementById('logRetention').value = settings.debug?.logRetention || 30;
            document.getElementById('enableDebugMode').checked = settings.debug?.debugMode || false;
            document.getElementById('enableTestMode').checked = settings.debug?.testMode || false;
        }

        // Load system status
        async function loadSystemStatus() {
            try {
                const response = await fetch('/api/bulk/status');
                const status = await response.json();
                
                // Update status indicators
                document.getElementById('activeCampaigns').textContent = Object.keys(status.activeCampaigns || {}).length;
                document.getElementById('messagesToday').textContent = status.throttling?.stats?.sentToday || 0;
                
                // WhatsApp and database status would need to be added to the status endpoint
                // For now, assuming they're connected if we get a response
                updateStatusBadge('whatsappStatus', 'Connected', 'success');
                updateStatusBadge('databaseStatus', 'Connected', 'success');
            } catch (error) {
                console.error('Error loading system status:', error);
                updateStatusBadge('whatsappStatus', 'Error', 'danger');
                updateStatusBadge('databaseStatus', 'Error', 'danger');
            }
        }

        function updateStatusBadge(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.textContent = text;
            element.className = `badge bg-${type}`;
        }

        // Update delay variance display
        function updateDelayVarianceDisplay() {
            const value = document.getElementById('delayVariance').value;
            document.getElementById('delayVarianceValue').textContent = value + '%';
        }

        // Save all settings
        async function saveAllSettings() {
            try {
                const settings = gatherFormData();
                
                // Client-side validation
                if (!validateSettings(settings)) {
                    return;
                }
                
                const response = await fetch('/api/bulk/settings', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    showAlert('Settings saved successfully', 'success');
                    addToRecentActivity('Settings updated');
                    currentSettings = settings;
                } else {
                    const error = await response.json();
                    showAlert('Error saving settings: ' + error.error, 'danger');
                }
            } catch (error) {
                showAlert('Error saving settings', 'danger');
            }
        }
        
        // Validate settings before submission
        function validateSettings(settings) {
            // Throttling validation
            if (settings.throttling.messagesPerMinute < 1 || settings.throttling.messagesPerMinute > 60) {
                showAlert('Messages per minute must be between 1 and 60', 'danger');
                return false;
            }
            if (settings.throttling.messagesPerHour < 1 || settings.throttling.messagesPerHour > 3600) {
                showAlert('Messages per hour must be between 1 and 3600', 'danger');
                return false;
            }
            if (settings.throttling.messagesPerDay < 1 || settings.throttling.messagesPerDay > 50000) {
                showAlert('Messages per day must be between 1 and 50000', 'danger');
                return false;
            }
            if (settings.throttling.messageDelay < 1000 || settings.throttling.messageDelay > 120000) {
                showAlert('Message delay must be between 1000 and 120000 milliseconds', 'danger');
                return false;
            }
            
            // Ban prevention validation
            if (settings.banPrevention.warmupIncreaseRate < 1 || settings.banPrevention.warmupIncreaseRate > 100) {
                showAlert('Warmup increase rate must be between 1 and 100', 'danger');
                return false;
            }
            if (settings.banPrevention.warmupDuration < 1 || settings.banPrevention.warmupDuration > 90) {
                showAlert('Warmup duration must be between 1 and 90 days', 'danger');
                return false;
            }
            
            // Retry validation
            if (settings.retry.maxAttempts < 0 || settings.retry.maxAttempts > 10) {
                showAlert('Max retry attempts must be between 0 and 10', 'danger');
                return false;
            }
            if (settings.retry.backoffMultiplier < 1 || settings.retry.backoffMultiplier > 5) {
                showAlert('Backoff multiplier must be between 1 and 5', 'danger');
                return false;
            }
            
            // Webhook validation
            if (settings.webhook.url && !isValidUrl(settings.webhook.url)) {
                showAlert('Invalid webhook URL format', 'danger');
                return false;
            }
            
            return true;
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }

        // Gather form data
        function gatherFormData() {
            const workingDays = [];
            ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].forEach((day, index) => {
                const dayNames = ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'];
                if (document.getElementById(`work${day}`).checked) {
                    workingDays.push(dayNames[index]);
                }
            });

            const webhookEvents = [];
            ['MessageSent', 'MessageFailed', 'CampaignStart', 'CampaignComplete'].forEach(event => {
                if (document.getElementById(`webhook${event}`).checked) {
                    webhookEvents.push(event.charAt(0).toLowerCase() + event.slice(1));
                }
            });

            return {
                throttling: {
                    messagesPerMinute: parseInt(document.getElementById('messagesPerMinute').value),
                    messagesPerHour: parseInt(document.getElementById('messagesPerHour').value),
                    messagesPerDay: parseInt(document.getElementById('messagesPerDay').value),
                    messageDelay: parseInt(document.getElementById('messageDelay').value),
                    delayVariance: parseInt(document.getElementById('delayVariance').value)
                },
                banPrevention: {
                    enabled: document.getElementById('enableBanPrevention').checked,
                    warmupMode: document.getElementById('enableWarmupMode').checked,
                    warmupIncreaseRate: parseInt(document.getElementById('warmupIncreaseRate').value),
                    warmupDuration: parseInt(document.getElementById('warmupDuration').value),
                    warmupStartVolume: parseInt(document.getElementById('warmupStartVolume').value)
                },
                workingHours: {
                    enabled: document.getElementById('enableWorkingHours').checked,
                    timezoneDetection: document.getElementById('enableTimeZoneDetection').checked,
                    startTime: document.getElementById('workingHoursStart').value,
                    endTime: document.getElementById('workingHoursEnd').value,
                    workingDays: workingDays
                },
                retry: {
                    maxAttempts: parseInt(document.getElementById('maxRetries').value),
                    delayMinutes: parseInt(document.getElementById('retryDelay').value),
                    backoffMultiplier: parseFloat(document.getElementById('backoffMultiplier').value)
                },
                webhook: {
                    url: document.getElementById('webhookUrl').value,
                    secret: document.getElementById('webhookSecret').value,
                    events: webhookEvents
                },
                debug: {
                    logLevel: document.getElementById('logLevel').value,
                    logRetention: parseInt(document.getElementById('logRetention').value),
                    debugMode: document.getElementById('enableDebugMode').checked,
                    testMode: document.getElementById('enableTestMode').checked
                }
            };
        }

        // Quick actions
        async function resetToDefaults() {
            if (!confirm('Are you sure you want to reset all settings to defaults? This cannot be undone.')) {
                return;
            }

            try {
                const response = await fetch('/api/bulk/settings/reset', {
                    method: 'POST'
                });

                if (response.ok) {
                    showAlert('Settings reset to defaults', 'success');
                    loadCurrentSettings();
                    addToRecentActivity('Settings reset to defaults');
                } else {
                    showAlert('Error resetting settings', 'danger');
                }
            } catch (error) {
                showAlert('Error resetting settings', 'danger');
            }
        }

        async function testWebhook() {
            const webhookUrl = document.getElementById('webhookUrl').value;
            if (!webhookUrl) {
                showAlert('Please enter a webhook URL first', 'warning');
                return;
            }
            
            // Validate URL format
            if (!isValidUrl(webhookUrl)) {
                showAlert('Invalid webhook URL format', 'danger');
                return;
            }

            try {
                const response = await fetch('/api/bulk/webhook/test', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ url: webhookUrl })
                });

                if (response.ok) {
                    showAlert('Webhook test successful', 'success');
                } else {
                    showAlert('Webhook test failed', 'danger');
                }
            } catch (error) {
                showAlert('Error testing webhook', 'danger');
            }
        }

        async function pauseAllCampaigns() {
            if (!confirm('Are you sure you want to pause all active campaigns?')) {
                return;
            }

            try {
                const response = await fetch('/api/bulk/campaigns/pause-all', {
                    method: 'POST'
                });

                if (response.ok) {
                    showAlert('All campaigns paused', 'success');
                    addToRecentActivity('All campaigns paused');
                } else {
                    showAlert('Error pausing campaigns', 'danger');
                }
            } catch (error) {
                showAlert('Error pausing campaigns', 'danger');
            }
        }

        function exportSettings() {
            const settings = gatherFormData();
            const dataStr = JSON.stringify(settings, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            
            const link = document.createElement('a');
            link.href = URL.createObjectURL(dataBlob);
            link.download = `whatsapp-bulk-settings-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            
            addToRecentActivity('Settings exported');
        }

        function importSettings(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    populateForm(settings);
                    showAlert('Settings imported successfully. Don\'t forget to save!', 'info');
                    addToRecentActivity('Settings imported');
                } catch (error) {
                    showAlert('Error importing settings: Invalid JSON file', 'danger');
                }
            };
            reader.readAsText(file);
        }

        // Utility functions
        function showAlert(message, type) {
            const alertsContainer = document.querySelector('.container');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type} alert-dismissible fade show mt-3`;
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertsContainer.insertBefore(alert, alertsContainer.firstChild);
            
            // Auto-dismiss after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }

        function addToRecentActivity(activity) {
            const activityDiv = document.getElementById('recentActivity');
            const timestamp = new Date().toLocaleTimeString();
            
            const activityItem = document.createElement('div');
            activityItem.className = 'border-bottom pb-2 mb-2';
            activityItem.innerHTML = `
                <small class="text-muted d-block">${timestamp}</small>
                <span>${activity}</span>
            `;
            
            // Remove "No recent changes" message
            if (activityDiv.querySelector('.text-center')) {
                activityDiv.innerHTML = '';
            }
            
            activityDiv.insertBefore(activityItem, activityDiv.firstChild);
            
            // Keep only last 5 activities
            const activities = activityDiv.querySelectorAll('div');
            if (activities.length > 5) {
                activities[activities.length - 1].remove();
            }
        }
    </script>
</body>
</html>
