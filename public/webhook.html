<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Webhook Configuration - WhatsApp Automation</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link rel="stylesheet" href="assets/styles/app.css">
  <style>
    body { 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      min-height: 100vh; 
      padding: 20px;
    }
    .main-container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 10px 50px rgba(0,0,0,0.2);
    }
    .page-header {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      margin-bottom: 30px;
      text-align: center;
    }
    .webhook-card {
      background: #f8f9fa;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 20px;
      border-left: 5px solid #25D366;
      box-shadow: 0 4px 15px rgba(0,0,0,0.08);
    }
    .form-label {
      font-weight: 600;
      color: #2c3e50;
      margin-bottom: 10px;
      display: block;
    }
    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 10px;
      padding: 12px 15px;
      transition: all 0.3s ease;
    }
    .form-control:focus, .form-select:focus {
      border-color: #25D366;
      box-shadow: 0 0 0 0.2rem rgba(37, 211, 102, 0.25);
    }
    textarea.form-control {
      min-height: 200px;
      font-family: 'Courier New', monospace;
      font-size: 0.9rem;
    }
    .btn-primary {
      background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
      border: none;
      padding: 12px 30px;
      border-radius: 10px;
      font-weight: 600;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(37, 211, 102, 0.3);
    }
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(37, 211, 102, 0.5);
    }
    .btn-secondary {
      background: #6c757d;
      border: none;
      padding: 12px 30px;
      border-radius: 10px;
      font-weight: 600;
    }
    .alert {
      border-radius: 10px;
      border: none;
      padding: 15px 20px;
    }
    .info-box {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
      border-left: 4px solid #2196F3;
    }
    .webhook-log {
      background: #2c3e50;
      color: #ecf0f1;
      border-radius: 10px;
      padding: 20px;
      font-family: 'Courier New', monospace;
      font-size: 0.85rem;
      max-height: 300px;
      overflow-y: auto;
    }
    .endpoint-box {
      background: white;
      border: 2px dashed #25D366;
      border-radius: 10px;
      padding: 15px;
      margin: 15px 0;
      font-family: 'Courier New', monospace;
      word-break: break-all;
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="page-header">
      <h1><i class="fas fa-webhook me-2"></i>Webhook Configuration</h1>
      <p class="mb-0">Configure webhooks to receive real-time WhatsApp events</p>
    </div>

    <div class="info-box">
      <h5><i class="fas fa-info-circle me-2"></i>About Webhooks</h5>
      <p class="mb-2">Webhooks allow you to receive real-time notifications when events occur in your WhatsApp account:</p>
      <ul class="mb-0">
        <li><strong>Incoming Messages:</strong> Get notified when someone sends you a message</li>
        <li><strong>Message Status:</strong> Track delivery and read receipts</li>
        <li><strong>Connection Events:</strong> Monitor connection status changes</li>
      </ul>
    </div>

    <!-- Multi-Account Architecture Info -->
    <div class="webhook-card">
      <h4 class="mb-3"><i class="fas fa-layer-group me-2"></i>Multi-Account Webhook Architecture</h4>
      <div class="row">
        <div class="col-md-6">
          <h6><i class="fas fa-server me-2"></i>Legacy API Webhooks</h6>
          <ul class="mb-3">
            <li>Single account webhook configuration</li>
            <li>Configured via API key settings</li>
            <li>All events from one WhatsApp account</li>
          </ul>
        </div>
        <div class="col-md-6">
          <h6><i class="fas fa-users me-2"></i>Multi-Account API Webhooks</h6>
          <ul class="mb-3">
            <li>Per-account webhook URLs</li>
            <li>Account-specific event filtering</li>
            <li>Configured during account creation</li>
          </ul>
        </div>
      </div>
      <div class="alert alert-info mb-0">
        <i class="fas fa-info-circle me-2"></i>
        <strong>Account Management:</strong> Configure webhook URLs when creating accounts at the 
        <a href="/account.html" class="alert-link">account management page</a>.
      </div>
    </div>

    <div class="webhook-card">
      <h4 class="mb-4"><i class="fas fa-cog me-2"></i>Webhook Testing</h4>
      
      <div class="mb-4">
        <label class="form-label">
          <i class="fas fa-link me-1"></i>Test Webhook Endpoint
        </label>
        <div class="endpoint-box">
          <strong>POST</strong> http://localhost:3000/webhook
        </div>
        <small class="text-muted">
          <i class="fas fa-lightbulb me-1"></i>This endpoint processes webhook events for testing purposes
        </small>
      </div>

      <!-- Account Selector for Multi-Account Testing -->
      <div class="mb-4">
        <label class="form-label">
          <i class="fas fa-mobile-alt me-1"></i>Test Account (Multi-Account API)
        </label>
        <select class="form-select" id="accountSelect">
          <option value="">Select account for testing (optional)</option>
        </select>
        <small class="text-muted">
          <i class="fas fa-info-circle me-1"></i>Select an account to test account-specific webhook events
        </small>
      </div>

      <form id="webhookForm">
        <div class="mb-4">
          <label class="form-label">
            <i class="fas fa-code me-1"></i>Test Webhook Data (JSON)
          </label>
          <textarea class="form-control" id="webhookData" name="data" required placeholder='{
  "event": "message",
  "phone_id": "test_account_1",
  "from": "1234567890@c.us",
  "body": "Test message from multi-account API",
  "timestamp": 1699000000,
  "type": "chat",
  "isGroup": false
}'></textarea>
          <small class="text-muted">
            <i class="fas fa-info-circle me-1"></i>Enter valid JSON to test your webhook. Use phone_id for multi-account events.
          </small>
        </div>

        <div class="d-flex gap-3 flex-wrap">
          <button type="submit" class="btn btn-primary">
            <i class="fas fa-paper-plane me-2"></i>Send Test Webhook
          </button>
          <button type="button" class="btn btn-secondary" id="btnClear">
            <i class="fas fa-eraser me-2"></i>Clear
          </button>
          <button type="button" class="btn btn-info" id="btnLoadTemplate">
            <i class="fas fa-file-code me-2"></i>Load Template
          </button>
          <a href="index.html" class="btn btn-outline-secondary">
            <i class="fas fa-home me-2"></i>Back to Dashboard
          </a>
        </div>
      </form>
    </div>

    <div class="webhook-card" id="resultCard" style="display: none;">
      <h4 class="mb-3">
        <i class="fas fa-terminal me-2"></i>Response
      </h4>
      <div id="result"></div>
    </div>

    <div class="webhook-card">
      <h4 class="mb-3">
        <i class="fas fa-list me-2"></i>Recent Webhook Logs
      </h4>
      <div class="webhook-log" id="webhookLogs">
        <div class="text-muted text-center">No webhook events yet...</div>
      </div>
    </div>

    <div class="webhook-card">
      <h4 class="mb-3">
        <i class="fas fa-book me-2"></i>Example Webhook Payloads
      </h4>
      
      <div class="accordion" id="examplesAccordion">
        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#example1">
              <i class="fas fa-comment me-2"></i>Legacy API - Incoming Message
            </button>
          </h2>
          <div id="example1" class="accordion-collapse collapse show" data-bs-parent="#examplesAccordion">
            <div class="accordion-body">
              <pre class="bg-dark text-light p-3 rounded"><code>{
  "event": "message",
  "from": "1234567890@c.us",
  "body": "Hello, this is a test message",
  "timestamp": 1699000000,
  "type": "chat",
  "isGroup": false,
  "messageId": "msg_12345"
}</code></pre>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#example2">
              <i class="fas fa-users me-2"></i>Multi-Account API - Message Event
            </button>
          </h2>
          <div id="example2" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
            <div class="accordion-body">
              <pre class="bg-dark text-light p-3 rounded"><code>{
  "event": "message",
  "phone_id": "business_account_1",
  "account_name": "Business WhatsApp",
  "from": "1234567890@c.us",
  "to": "0987654321@c.us",
  "body": "Hello from multi-account system",
  "timestamp": 1699000000,
  "type": "chat",
  "isGroup": false,
  "messageId": "msg_67890",
  "author": null,
  "fromMe": false
}</code></pre>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#example3">
              <i class="fas fa-check-double me-2"></i>Message Status Update
            </button>
          </h2>
          <div id="example3" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
            <div class="accordion-body">
              <pre class="bg-dark text-light p-3 rounded"><code>{
  "event": "message_ack",
  "phone_id": "business_account_1",
  "messageId": "msg_67890",
  "ack": "read",
  "timestamp": 1699000000,
  "status": "delivered"
}</code></pre>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#example4">
              <i class="fas fa-plug me-2"></i>Account Connection Event
            </button>
          </h2>
          <div id="example4" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
            <div class="accordion-body">
              <pre class="bg-dark text-light p-3 rounded"><code>{
  "event": "ready",
  "phone_id": "business_account_1",
  "account_name": "Business WhatsApp",
  "status": "connected",
  "timestamp": 1699000000,
  "client_info": {
    "platform": "android",
    "version": "2.23.20.0"
  }
}</code></pre>
            </div>
          </div>
        </div>

        <div class="accordion-item">
          <h2 class="accordion-header">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#example5">
              <i class="fas fa-image me-2"></i>Media Message Event
            </button>
          </h2>
          <div id="example5" class="accordion-collapse collapse" data-bs-parent="#examplesAccordion">
            <div class="accordion-body">
              <pre class="bg-dark text-light p-3 rounded"><code>{
  "event": "message",
  "phone_id": "business_account_1",
  "from": "1234567890@c.us",
  "body": "",
  "timestamp": 1699000000,
  "type": "image",
  "hasMedia": true,
  "mimetype": "image/jpeg",
  "filename": "photo.jpg",
  "caption": "Check out this image!",
  "mediaSize": 245760
}</code></pre>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let webhookLogs = [];
    let accounts = [];

    // Load accounts on page load
    window.onload = function() {
      loadAccounts();
      addLog('Webhook configuration page loaded', 'success');
    };

    async function loadAccounts() {
      try {
        const response = await fetch('/api/accounts');
        const data = await response.json();
        
        if (data.success) {
          accounts = data.accounts;
          updateAccountSelect();
          addLog(`Loaded ${accounts.length} accounts`, 'info');
        } else {
          addLog('Failed to load accounts: ' + data.error, 'error');
        }
      } catch (error) {
        addLog('Error loading accounts: ' + error.message, 'error');
      }
    }

    function updateAccountSelect() {
      const select = document.getElementById('accountSelect');
      select.innerHTML = '<option value="">Select account for testing (optional)</option>';
      
      accounts.forEach(account => {
        const option = document.createElement('option');
        option.value = account.phone_id;
        option.textContent = `${account.phone_id} (${account.name || 'Unnamed'}) - ${account.status}`;
        option.dataset.status = account.status;
        select.appendChild(option);
      });
    }

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const log = { timestamp, message, type };
      webhookLogs.unshift(log);
      if (webhookLogs.length > 15) webhookLogs.pop();
      
      const logsDiv = document.getElementById('webhookLogs');
      const colorMap = { success: '#2ecc71', error: '#e74c3c', info: '#3498db', warning: '#f39c12' };
      
      logsDiv.innerHTML = webhookLogs.map(l => 
        `<div style="margin-bottom: 10px; padding-bottom: 10px; border-bottom: 1px solid #34495e;">
          <span style="color: ${colorMap[l.type]};">[${l.timestamp}]</span> ${l.message}
        </div>`
      ).join('');
    }

    document.getElementById('webhookForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      const resultCard = document.getElementById('resultCard');
      const resultDiv = document.getElementById('result');
      
      let data;
      try {
        data = JSON.parse(this.data.value);
        addLog('Parsing JSON... âœ“', 'success');
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Invalid JSON:</strong> ${err.message}
          </div>`;
        resultCard.style.display = 'block';
        addLog('JSON parsing failed: ' + err.message, 'error');
        return;
      }

      try {
        addLog('Sending webhook request...', 'info');
        const res = await fetch('/webhook', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        
        const responseText = await res.text();
        
        if (res.ok) {
          resultDiv.innerHTML = `
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Webhook sent successfully!</strong>
              <hr>
              <div class="webhook-log">Status: ${res.status} ${res.statusText}<br>Response: ${responseText || 'OK'}</div>
            </div>`;
          addLog('Webhook sent successfully (Status: ' + res.status + ')', 'success');
        } else {
          resultDiv.innerHTML = `
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-circle me-2"></i>
              <strong>Webhook sent with status ${res.status}</strong>
              <hr>
              <div class="webhook-log">${responseText}</div>
            </div>`;
          addLog('Webhook response: ' + res.status, 'error');
        }
        
        resultCard.style.display = 'block';
      } catch (err) {
        resultDiv.innerHTML = `
          <div class="alert alert-danger">
            <i class="fas fa-times-circle me-2"></i>
            <strong>Error sending webhook:</strong> ${err.message}
          </div>`;
        resultCard.style.display = 'block';
        addLog('Error: ' + err.message, 'error');
      }
    });

    document.getElementById('btnClear').addEventListener('click', function() {
      document.getElementById('webhookData').value = '';
      document.getElementById('resultCard').style.display = 'none';
      addLog('Webhook data cleared', 'info');
    });

    document.getElementById('btnLoadTemplate').addEventListener('click', function() {
      const selectedAccount = document.getElementById('accountSelect').value;
      
      let template;
      if (selectedAccount) {
        // Multi-account template
        template = {
          event: "message",
          phone_id: selectedAccount,
          account_name: "Test Account",
          from: "1234567890@c.us",
          to: "0987654321@c.us",
          body: "Test message from multi-account API",
          timestamp: Math.floor(Date.now() / 1000),
          type: "chat",
          isGroup: false,
          messageId: "msg_" + Math.random().toString(36).substr(2, 9),
          author: null,
          fromMe: false
        };
      } else {
        // Legacy API template
        template = {
          event: "message",
          from: "1234567890@c.us",
          body: "Test message from legacy API",
          timestamp: Math.floor(Date.now() / 1000),
          type: "chat",
          isGroup: false,
          messageId: "msg_" + Math.random().toString(36).substr(2, 9)
        };
      }
      
      document.getElementById('webhookData').value = JSON.stringify(template, null, 2);
      addLog('Template loaded for ' + (selectedAccount ? 'multi-account' : 'legacy') + ' API', 'info');
    });

    // Account selector change handler
    document.getElementById('accountSelect').addEventListener('change', function() {
      const selectedAccount = this.value;
      if (selectedAccount) {
        addLog(`Selected account: ${selectedAccount}`, 'info');
      } else {
        addLog('No account selected - will use legacy API format', 'info');
      }
    });
  </script>
</body>
</html>
