<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Template Builder - WhatsApp Bulk Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .template-preview {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            min-height: 200px;
        }
        .variable-tag {
            background: #e3f2fd;
            color: #1976d2;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.875rem;
            margin: 2px;
            display: inline-block;
        }
        .compliance-indicator {
            padding: 0.5rem;
            border-radius: 0.375rem;
            margin-top: 1rem;
        }
        .compliance-low { background: #d4edda; color: #155724; }
        .compliance-medium { background: #fff3cd; color: #856404; }
        .compliance-high { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="bulk-dashboard.html">
                <i class="fab fa-whatsapp me-2"></i>
                Template Builder
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="bulk-dashboard.html">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">Template Builder</h1>
                        <p class="text-muted">Create and manage message templates with variables and compliance checking</p>
                    </div>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#templateModal" id="newTemplateBtn">
                        <i class="fas fa-plus me-2"></i>New Template
                    </button>
                </div>
            </div>
        </div>

        <!-- Templates List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title mb-0">Message Templates</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="categoryFilter">
                                            <option value="">All Categories</option>
                                            <option value="promotional">Promotional</option>
                                            <option value="transactional">Transactional</option>
                                            <option value="notification">Notification</option>
                                            <option value="reminder">Reminder</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control form-control-sm" id="searchTemplates" placeholder="Search templates...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="templatesTable">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading templates...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Template Modal -->
    <div class="modal fade" id="templateModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="templateModalTitle">Create New Template</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="templateForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="templateName" class="form-label">Template Name *</label>
                                    <input type="text" class="form-control" id="templateName" required>
                                </div>
                                <div class="mb-3">
                                    <label for="templateCategory" class="form-label">Category *</label>
                                    <select class="form-select" id="templateCategory" required>
                                        <option value="">Select Category</option>
                                        <option value="promotional">Promotional</option>
                                        <option value="transactional">Transactional</option>
                                        <option value="notification">Notification</option>
                                        <option value="reminder">Reminder</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label for="templateBody" class="form-label">Message Body *</label>
                                    <textarea class="form-control" id="templateBody" rows="8" required placeholder="Hello {{name}}, your order {{order_id}} is ready for pickup!"></textarea>
                                    <div class="form-text">
                                        Use {{variable_name}} for dynamic content. Example: {{name}}, {{phone}}, {{order_id}}
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="templateMediaUrl" class="form-label">Media URL (Optional)</label>
                                    <input type="url" class="form-control" id="templateMediaUrl" placeholder="https://example.com/image.jpg">
                                </div>
                                <div class="mb-3">
                                    <label for="templateTags" class="form-label">Tags (Optional)</label>
                                    <input type="text" class="form-control" id="templateTags" placeholder="promotion, sale, discount">
                                    <div class="form-text">Comma-separated tags for organization</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Live Preview</label>
                                    <div class="template-preview" id="templatePreview">
                                        <div class="text-muted">
                                            <i class="fas fa-eye me-2"></i>
                                            Preview will appear here as you type...
                                        </div>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Detected Variables</label>
                                    <div id="detectedVariables">
                                        <span class="text-muted">No variables detected</span>
                                    </div>
                                </div>
                                <div class="mb-3">
                                    <label for="sampleData" class="form-label">Sample Data (JSON)</label>
                                    <textarea class="form-control" id="sampleData" rows="4" placeholder='{"name": "John Doe", "order_id": "12345"}'></textarea>
                                    <div class="form-text">Provide sample data to preview the template</div>
                                </div>
                                <div id="complianceCheck" class="compliance-indicator compliance-low" style="display: none;">
                                    <strong>Compliance Status:</strong>
                                    <span id="complianceStatus">Checking...</span>
                                    <div id="complianceDetails" class="small mt-1"></div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" id="saveTemplateBtn">
                        <i class="fas fa-save me-2"></i>Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let currentTemplateId = null;
        let templates = [];

        // Load templates
        async function loadTemplates() {
            try {
                const category = document.getElementById('categoryFilter').value;
                const search = document.getElementById('searchTemplates').value;
                
                let url = '/api/bulk/templates?limit=50';
                if (category) url += `&category=${category}`;
                if (search) url += `&search=${search}`;
                
                const response = await fetch(url);
                const data = await response.json();
                templates = data.templates || [];
                
                renderTemplatesTable();
            } catch (error) {
                console.error('Error loading templates:', error);
                document.getElementById('templatesTable').innerHTML = 
                    '<div class="alert alert-danger">Error loading templates</div>';
            }
        }

        function renderTemplatesTable() {
            const tableDiv = document.getElementById('templatesTable');
            
            if (templates.length === 0) {
                tableDiv.innerHTML = '<div class="text-center text-muted">No templates found</div>';
                return;
            }

            tableDiv.innerHTML = `
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Category</th>
                                <th>Variables</th>
                                <th>Compliance</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${templates.map(template => `
                                <tr>
                                    <td>
                                        <strong>${template.name}</strong>
                                        <div class="text-muted small">${truncateText(template.body, 50)}</div>
                                    </td>
                                    <td><span class="badge bg-secondary">${template.category}</span></td>
                                    <td>
                                        ${(template.variables || []).map(v => 
                                            `<span class="variable-tag">${v}</span>`
                                        ).join('')}
                                    </td>
                                    <td>
                                        <span class="badge bg-${getComplianceColor(template.complianceStatus)}">
                                            ${template.complianceStatus || 'unknown'}
                                        </span>
                                    </td>
                                    <td>${new Date(template.createdAt).toLocaleDateString()}</td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1 edit-template-btn" data-template-id="${template.id}">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-info me-1 preview-template-btn" data-template-id="${template.id}">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button class="btn btn-sm btn-outline-danger delete-template-btn" data-template-id="${template.id}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function truncateText(text, length) {
            return text.length > length ? text.substring(0, length) + '...' : text;
        }

        function getComplianceColor(status) {
            switch(status) {
                case 'low': return 'success';
                case 'medium': return 'warning';
                case 'high': return 'danger';
                default: return 'secondary';
            }
        }

        function openTemplateModal(templateId = null) {
            currentTemplateId = templateId;
            const modal = document.getElementById('templateModal');
            const title = document.getElementById('templateModalTitle');
            
            if (templateId) {
                title.textContent = 'Edit Template';
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateCategory').value = template.category;
                    document.getElementById('templateBody').value = template.body;
                    document.getElementById('templateMediaUrl').value = template.mediaUrl || '';
                    document.getElementById('templateTags').value = (template.tags || []).join(', ');
                }
            } else {
                title.textContent = 'Create New Template';
                document.getElementById('templateForm').reset();
                clearPreview();
            }
        }

        function editTemplate(templateId) {
            openTemplateModal(templateId);
            new bootstrap.Modal(document.getElementById('templateModal')).show();
        }

        async function deleteTemplate(templateId) {
            if (!confirm('Are you sure you want to delete this template?')) return;
            
            try {
                const response = await fetch(`/api/bulk/templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                if (response.ok) {
                    await loadTemplates();
                    alert('Template deleted successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error deleting template:', error);
                alert('Error deleting template');
            }
        }

        async function saveTemplate() {
            const form = document.getElementById('templateForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const templateData = {
                name: document.getElementById('templateName').value,
                category: document.getElementById('templateCategory').value,
                body: document.getElementById('templateBody').value,
                mediaUrl: document.getElementById('templateMediaUrl').value || null,
                tags: document.getElementById('templateTags').value.split(',').map(t => t.trim()).filter(t => t)
            };

            try {
                const url = currentTemplateId 
                    ? `/api/bulk/templates/${currentTemplateId}` 
                    : '/api/bulk/templates';
                const method = currentTemplateId ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(templateData)
                });

                if (response.ok) {
                    bootstrap.Modal.getInstance(document.getElementById('templateModal')).hide();
                    await loadTemplates();
                    alert('Template saved successfully');
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error saving template:', error);
                alert('Error saving template');
            }
        }

        // Real-time preview and compliance checking
        document.getElementById('templateBody').addEventListener('input', debounce(updatePreview, 500));
        document.getElementById('sampleData').addEventListener('input', debounce(updatePreview, 500));

        async function updatePreview() {
            const body = document.getElementById('templateBody').value;
            const sampleDataText = document.getElementById('sampleData').value;
            
            // Extract and display variables
            const variables = extractVariables(body);
            const variablesDiv = document.getElementById('detectedVariables');
            variablesDiv.innerHTML = ''; // Clear previous content
            if (variables.length > 0) {
                variables.forEach(v => {
                    const span = document.createElement('span');
                    span.className = 'variable-tag';
                    span.textContent = v; // Safe: uses textContent instead of innerHTML
                    variablesDiv.appendChild(span);
                });
            } else {
                variablesDiv.innerHTML = '<span class="text-muted">No variables detected</span>';
            }

            // Preview with sample data
            let sampleData = {};
            try {
                if (sampleDataText.trim()) {
                    sampleData = JSON.parse(sampleDataText);
                }
            } catch (e) {
                // Invalid JSON, use empty object
            }

            // Generate preview
            try {
                const response = await fetch('/api/bulk/templates/preview', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body, sampleData })
                });

                if (response.ok) {
                    const data = await response.json();
                    const previewDiv = document.getElementById('templatePreview');
                    previewDiv.innerHTML = ''; // Clear previous content
                    
                    // Create wrapper div
                    const wrapper = document.createElement('div');
                    wrapper.className = 'border-start border-primary ps-3';
                    
                    // Safely set text content and preserve line breaks
                    const lines = (data.preview || '').split('\n');
                    lines.forEach((line, index) => {
                        const textNode = document.createTextNode(line);
                        wrapper.appendChild(textNode);
                        if (index < lines.length - 1) {
                            wrapper.appendChild(document.createElement('br'));
                        }
                    });
                    
                    previewDiv.appendChild(wrapper);
                }
            } catch (error) {
                console.error('Error generating preview:', error);
            }

            // Compliance check
            if (body.trim()) {
                checkCompliance(body);
            }
        }

        async function checkCompliance(messageContent) {
            try {
                const response = await fetch('/api/bulk/compliance/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ messageContent })
                });

                if (response.ok) {
                    const data = await response.json();
                    const compliance = data.compliance;
                    
                    const checkDiv = document.getElementById('complianceCheck');
                    const statusSpan = document.getElementById('complianceStatus');
                    const detailsDiv = document.getElementById('complianceDetails');
                    
                    checkDiv.style.display = 'block';
                    checkDiv.className = `compliance-indicator compliance-${compliance.riskLevel}`;
                    statusSpan.textContent = `${compliance.riskLevel.toUpperCase()} (Score: ${compliance.riskScore})`;
                    
                    // Safely build compliance details
                    detailsDiv.innerHTML = ''; // Clear previous content
                    
                    if (compliance.violations.length > 0) {
                        const violationsStrong = document.createElement('strong');
                        violationsStrong.textContent = 'Violations: ';
                        detailsDiv.appendChild(violationsStrong);
                        detailsDiv.appendChild(document.createTextNode(compliance.violations.join(', ')));
                        detailsDiv.appendChild(document.createElement('br'));
                    }
                    if (compliance.warnings.length > 0) {
                        const warningsStrong = document.createElement('strong');
                        warningsStrong.textContent = 'Warnings: ';
                        detailsDiv.appendChild(warningsStrong);
                        detailsDiv.appendChild(document.createTextNode(compliance.warnings.join(', ')));
                    }
                    if (compliance.violations.length === 0 && compliance.warnings.length === 0) {
                        detailsDiv.textContent = 'No compliance issues detected';
                    }
                }
            } catch (error) {
                console.error('Error checking compliance:', error);
            }
        }

        function extractVariables(text) {
            const matches = text.match(/\{\{([^}]+)\}\}/g);
            if (!matches) return [];
            return [...new Set(matches.map(match => match.slice(2, -2).trim()))];
        }

        function clearPreview() {
            document.getElementById('templatePreview').innerHTML = 
                '<div class="text-muted"><i class="fas fa-eye me-2"></i>Preview will appear here as you type...</div>';
            document.getElementById('detectedVariables').innerHTML = 
                '<span class="text-muted">No variables detected</span>';
            document.getElementById('complianceCheck').style.display = 'none';
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Event listeners
        document.getElementById('categoryFilter').addEventListener('change', loadTemplates);
        document.getElementById('searchTemplates').addEventListener('input', debounce(loadTemplates, 500));
        
        // New template button (CSP-compliant)
        document.getElementById('newTemplateBtn').addEventListener('click', function() {
            console.log('✅ New Template button clicked');
            openTemplateModal();
        });
        
        // Save template button (CSP-compliant)
        document.getElementById('saveTemplateBtn').addEventListener('click', function() {
            console.log('✅ Save Template button clicked');
            saveTemplate();
        });
        
        // Event delegation for dynamically created buttons (CSP-compliant)
        document.getElementById('templatesTable').addEventListener('click', function(e) {
            const editBtn = e.target.closest('.edit-template-btn');
            const previewBtn = e.target.closest('.preview-template-btn');
            const deleteBtn = e.target.closest('.delete-template-btn');
            
            if (editBtn) {
                const templateId = parseInt(editBtn.dataset.templateId);
                console.log('✅ Edit template clicked:', templateId);
                editTemplate(templateId);
            } else if (previewBtn) {
                const templateId = parseInt(previewBtn.dataset.templateId);
                console.log('✅ Preview template clicked:', templateId);
                previewTemplate(templateId);
            } else if (deleteBtn) {
                const templateId = parseInt(deleteBtn.dataset.templateId);
                console.log('✅ Delete template clicked:', templateId);
                deleteTemplate(templateId);
            }
        });

        // Initial load
        loadTemplates();
    </script>
</body>
</html>
