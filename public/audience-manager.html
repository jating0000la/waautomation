<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audience Manager - WhatsApp Bulk Messaging</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075); }
        .import-zone {
            border: 2px dashed #dee2e6;
            border-radius: 0.5rem;
            padding: 2rem;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .import-zone:hover, .import-zone.drag-over {
            border-color: #007bff;
            background-color: #f8f9ff;
        }
        .column-mapping {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
        }
        .consent-badge {
            font-size: 0.75rem;
        }
        .audience-stats {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="bulk-dashboard.html">
                <i class="fab fa-whatsapp me-2"></i>
                Audience Manager
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="bulk-dashboard.html">
                    <i class="fas fa-arrow-left me-1"></i>Back to Dashboard
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h1 class="h3">Audience Manager</h1>
                        <p class="text-muted">Import, manage, and organize your contact lists</p>
                    </div>
                    <div>
                        <button class="btn btn-success me-2" data-bs-toggle="modal" data-bs-target="#importModal">
                            <i class="fas fa-upload me-2"></i>Import Contacts
                        </button>
                        <button class="btn btn-warning" data-bs-toggle="modal" data-bs-target="#dndModal">
                            <i class="fas fa-ban me-2"></i>Manage DND
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audience Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card audience-stats">
                    <div class="card-body text-center">
                        <i class="fas fa-users fa-2x mb-2"></i>
                        <h5>Total Contacts</h5>
                        <h2 id="totalContacts">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                        <h5>Opted In</h5>
                        <h2 id="optedInContacts">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-question-circle fa-2x mb-2"></i>
                        <h5>Unknown</h5>
                        <h2 id="unknownContacts">-</h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-danger text-white">
                    <div class="card-body text-center">
                        <i class="fas fa-ban fa-2x mb-2"></i>
                        <h5>DND List</h5>
                        <h2 id="dndContacts">-</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Audience List -->
        <div class="row">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="card-title mb-0">Contact List</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="consentFilter">
                                            <option value="">All Consent Status</option>
                                            <option value="opted_in">Opted In</option>
                                            <option value="unknown">Unknown</option>
                                            <option value="opted_out">Opted Out</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <input type="text" class="form-control form-control-sm" id="searchContacts" placeholder="Search contacts...">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="contactsTable">
                            <div class="text-center">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading contacts...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal fade" id="importModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Import Contacts</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6>Step 1: Choose Import Method</h6>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="importMethod" id="csvImport" value="csv" checked>
                                    <label class="form-check-label" for="csvImport">
                                        <i class="fas fa-file-csv me-2"></i>Upload CSV File
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="importMethod" id="pasteImport" value="paste">
                                    <label class="form-check-label" for="pasteImport">
                                        <i class="fas fa-clipboard me-2"></i>Paste Data
                                    </label>
                                </div>
                            </div>

                            <!-- CSV Upload -->
                            <div id="csvUploadSection">
                                <h6>Upload CSV File</h6>
                                <div class="import-zone" id="csvUploadZone">
                                    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
                                    <p class="mb-0">Click to select CSV file or drag and drop</p>
                                    <small class="text-muted">Supported format: CSV (max 5MB)</small>
                                </div>
                                <input type="file" id="csvFile" accept=".csv" style="display: none;">
                            </div>

                            <!-- Paste Data -->
                            <div id="pasteDataSection" style="display: none;">
                                <h6>Paste Tab-Separated Data</h6>
                                <textarea class="form-control" id="pasteData" rows="8" placeholder="Name	Phone	Email
John Doe	+1234567890	john@example.com
Jane Smith	+0987654321	jane@example.com"></textarea>
                                <small class="text-muted">Paste data from Excel or Google Sheets (tab-separated)</small>
                            </div>

                            <div class="mt-3">
                                <label for="audienceId" class="form-label">Audience ID *</label>
                                <input type="text" class="form-control" id="audienceId" required placeholder="e.g., main_list, promo_2024">
                                <div class="form-text">Unique identifier for this audience segment</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6>Step 2: Map Columns</h6>
                            <div class="column-mapping">
                                <div class="mb-3">
                                    <label class="form-label">Phone Number Column *</label>
                                    <select class="form-select" id="phoneColumn" required>
                                        <option value="">Select column...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Name Column</label>
                                    <select class="form-select" id="nameColumn">
                                        <option value="">Select column...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Consent Status Column</label>
                                    <select class="form-select" id="consentColumn">
                                        <option value="">Select column...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Tags Column</label>
                                    <select class="form-select" id="tagsColumn">
                                        <option value="">Select column...</option>
                                    </select>
                                </div>
                            </div>

                            <h6>Data Preview</h6>
                            <div id="dataPreview" class="border rounded p-2" style="height: 200px; overflow-y: auto;">
                                <small class="text-muted">Upload or paste data to see preview...</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success" id="importBtn" disabled>
                        <i class="fas fa-upload me-2"></i>Import Contacts
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- DND Management Modal -->
    <div class="modal fade" id="dndModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Do Not Disturb (DND) Management</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="dndPhone" placeholder="Enter phone number">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-warning w-100" id="addToDndBtn">
                                <i class="fas fa-ban me-2"></i>Add to DND
                            </button>
                        </div>
                    </div>
                    <div id="dndList">
                        <div class="text-center">
                            <i class="fas fa-spinner fa-spin"></i>
                            Loading DND list...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        let parsedData = [];
        let dndList = [];

        // Load audience statistics
        async function loadStats() {
            try {
                // Load general stats
                const response = await fetch('/api/bulk/audiences?limit=1');
                const data = await response.json();
                document.getElementById('totalContacts').textContent = data.pagination?.total || 0;

                // Load by consent status
                const consentStats = await Promise.all([
                    fetch('/api/bulk/audiences?consentStatus=opted_in&limit=1'),
                    fetch('/api/bulk/audiences?consentStatus=unknown&limit=1'),
                    fetch('/api/bulk/audiences?consentStatus=opted_out&limit=1')
                ]);

                const [optedIn, unknown, optedOut] = await Promise.all(
                    consentStats.map(r => r.json())
                );

                document.getElementById('optedInContacts').textContent = optedIn.pagination?.total || 0;
                document.getElementById('unknownContacts').textContent = unknown.pagination?.total || 0;

                // Load DND count (assuming you have an endpoint for this)
                document.getElementById('dndContacts').textContent = '0'; // Placeholder
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        // Load contacts
        async function loadContacts() {
            try {
                const consent = document.getElementById('consentFilter').value;
                const search = document.getElementById('searchContacts').value;
                
                let url = '/api/bulk/audiences?limit=50';
                if (consent) url += `&consentStatus=${consent}`;
                if (search) url += `&search=${search}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                renderContactsTable(data.audiences || []);
            } catch (error) {
                console.error('Error loading contacts:', error);
                document.getElementById('contactsTable').innerHTML = 
                    '<div class="alert alert-danger">Error loading contacts</div>';
            }
        }

        function renderContactsTable(contacts) {
            const tableDiv = document.getElementById('contactsTable');
            
            if (contacts.length === 0) {
                tableDiv.innerHTML = '<div class="text-center text-muted">No contacts found</div>';
                return;
            }

            // Create table structure safely
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';
            
            const table = document.createElement('table');
            table.className = 'table table-hover';
            
            // Create header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            ['Name', 'Phone', 'Consent Status', 'Tags', 'Source', 'Added', 'Actions'].forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Create body
            const tbody = document.createElement('tbody');
            contacts.forEach(contact => {
                const row = document.createElement('tr');
                
                // Name cell (safe)
                const nameCell = document.createElement('td');
                if (contact.name) {
                    nameCell.textContent = contact.name;
                } else {
                    const em = document.createElement('em');
                    em.textContent = 'No name';
                    nameCell.appendChild(em);
                }
                row.appendChild(nameCell);
                
                // Phone cell (masked for privacy)
                const phoneCell = document.createElement('td');
                phoneCell.textContent = maskPhone(contact.phone);
                phoneCell.title = 'Click to reveal';
                phoneCell.style.cursor = 'pointer';
                phoneCell.onclick = function() {
                    this.textContent = this.textContent.includes('*') ? contact.phone : maskPhone(contact.phone);
                };
                row.appendChild(phoneCell);
                
                // Consent cell
                const consentCell = document.createElement('td');
                const consentBadge = document.createElement('span');
                consentBadge.className = `badge consent-badge bg-${getConsentColor(contact.consentStatus)}`;
                consentBadge.textContent = contact.consentStatus;
                consentCell.appendChild(consentBadge);
                row.appendChild(consentCell);
                
                // Tags cell (safe)
                const tagsCell = document.createElement('td');
                (contact.tags || []).forEach(tag => {
                    const tagBadge = document.createElement('span');
                    tagBadge.className = 'badge bg-secondary me-1';
                    tagBadge.textContent = tag;
                    tagsCell.appendChild(tagBadge);
                });
                row.appendChild(tagsCell);
                
                // Source cell (safe)
                const sourceCell = document.createElement('td');
                const sourceBadge = document.createElement('span');
                sourceBadge.className = 'badge bg-light text-dark';
                sourceBadge.textContent = contact.source || 'manual';
                sourceCell.appendChild(sourceBadge);
                row.appendChild(sourceCell);
                
                // Date cell
                const dateCell = document.createElement('td');
                dateCell.textContent = new Date(contact.createdAt).toLocaleDateString();
                row.appendChild(dateCell);
                
                // Actions cell
                const actionsCell = document.createElement('td');
                
                const dndBtn = document.createElement('button');
                dndBtn.className = 'btn btn-sm btn-outline-warning me-1';
                dndBtn.title = 'Add to DND';
                dndBtn.onclick = () => addToDnd(contact.phone);
                dndBtn.innerHTML = '<i class="fas fa-ban"></i>';
                actionsCell.appendChild(dndBtn);
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-outline-danger';
                deleteBtn.title = 'Delete Contact';
                deleteBtn.onclick = () => deleteContact(contact.id);
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(actionsCell);
                tbody.appendChild(row);
            });
            
            table.appendChild(tbody);
            wrapper.appendChild(table);
            
            tableDiv.innerHTML = '';
            tableDiv.appendChild(wrapper);
        }
        
        function maskPhone(phone) {
            if (!phone || phone.length < 10) return phone;
            // Show only last 4 digits: +91****7890
            return phone.slice(0, -4).replace(/\d/g, '*') + phone.slice(-4);
        }

        function getConsentColor(status) {
            switch(status) {
                case 'opted_in': return 'success';
                case 'opted_out': return 'danger';
                default: return 'warning';
            }
        }

        // Import method switching
        document.querySelectorAll('input[name="importMethod"]').forEach(radio => {
            radio.addEventListener('change', function() {
                if (this.value === 'csv') {
                    document.getElementById('csvUploadSection').style.display = 'block';
                    document.getElementById('pasteDataSection').style.display = 'none';
                } else {
                    document.getElementById('csvUploadSection').style.display = 'none';
                    document.getElementById('pasteDataSection').style.display = 'block';
                }
                updateColumnOptions();
            });
        });

        // File upload handling
        document.getElementById('csvFile').addEventListener('change', function(e) {
            console.log('üìÅ CSV file selected');
            const file = e.target.files[0];
            if (file) {
                console.log('File name:', file.name, 'Size:', file.size, 'bytes');
                const reader = new FileReader();
                reader.onload = function(e) {
                    console.log('File read complete, parsing CSV...');
                    parseCSVData(e.target.result);
                };
                reader.onerror = function(e) {
                    console.error('Error reading file:', e);
                    alert('Error reading file. Please try again.');
                };
                reader.readAsText(file);
            }
        });

        // Paste data handling
        document.getElementById('pasteData').addEventListener('input', function() {
            const data = this.value.trim();
            if (data) {
                parsePasteData(data);
            }
        });

        function parseCSVData(csvText) {
            console.log('parseCSVData called with text length:', csvText.length);
            const lines = csvText.trim().split('\n');
            console.log('CSV lines found:', lines.length);
            
            if (lines.length < 2) {
                console.warn('Not enough lines in CSV');
                alert('CSV file must have at least a header row and one data row');
                return;
            }

            const headers = lines[0].split(',').map(h => sanitizeCSVValue(h.trim().replace(/"/g, '')));
            console.log('CSV headers detected:', headers);
            
            parsedData = lines.slice(1).map(line => {
                const values = line.split(',').map(v => sanitizeCSVValue(v.trim().replace(/"/g, '')));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            });

            console.log('CSV parsed data rows:', parsedData.length);
            updateColumnOptions(headers);
            updateDataPreview();
            
            // Force enable button if we have data
            if (parsedData.length > 0) {
                console.log('Enabling import button (CSV)');
                document.getElementById('importBtn').disabled = false;
            }
        }

        function parsePasteData(pasteText) {
            console.log('parsePasteData called with data length:', pasteText.length);
            const lines = pasteText.trim().split('\n');
            console.log('Found lines:', lines.length);
            
            if (lines.length < 2) {
                console.warn('Not enough lines in paste data');
                return;
            }

            const headers = lines[0].split('\t').map(h => sanitizeCSVValue(h.trim()));
            console.log('Headers detected:', headers);
            
            parsedData = lines.slice(1).map(line => {
                const values = line.split('\t').map(v => sanitizeCSVValue(v.trim()));
                const row = {};
                headers.forEach((header, index) => {
                    row[header] = values[index] || '';
                });
                return row;
            });

            console.log('Parsed data rows:', parsedData.length);
            updateColumnOptions(headers);
            updateDataPreview();
            
            // Force enable button if we have data
            if (parsedData.length > 0) {
                console.log('Enabling import button');
                document.getElementById('importBtn').disabled = false;
            }
        }
        
        function sanitizeCSVValue(value) {
            if (!value) return '';
            
            // Remove leading special characters that can trigger formulas
            const dangerous = ['=', '+', '-', '@', '\t', '\r'];
            let sanitized = value;
            
            if (dangerous.some(char => sanitized.startsWith(char))) {
                sanitized = "'" + sanitized; // Prefix with single quote
            }
            
            // Remove null bytes and other control characters
            sanitized = sanitized.replace(/[\x00-\x08\x0B-\x0C\x0E-\x1F\x7F]/g, '');
            
            return sanitized;
        }

        function updateColumnOptions(headers = []) {
            if (parsedData.length > 0 && headers.length === 0) {
                headers = Object.keys(parsedData[0]);
            }

            const selects = ['phoneColumn', 'nameColumn', 'consentColumn', 'tagsColumn'];
            selects.forEach(selectId => {
                const select = document.getElementById(selectId);
                select.innerHTML = '<option value="">Select column...</option>';
                headers.forEach(header => {
                    select.innerHTML += `<option value="${header}">${header}</option>`;
                });
            });

            document.getElementById('importBtn').disabled = parsedData.length === 0;
        }

        function updateDataPreview() {
            const previewDiv = document.getElementById('dataPreview');
            
            if (parsedData.length === 0) {
                previewDiv.innerHTML = '<small class="text-muted">No data to preview</small>';
                return;
            }

            const headers = Object.keys(parsedData[0]);
            const sampleRows = parsedData.slice(0, 5);

            // Build table safely
            previewDiv.innerHTML = '';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'table-responsive';
            
            const table = document.createElement('table');
            table.className = 'table table-sm';
            
            // Header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');
            headers.forEach(h => {
                const th = document.createElement('th');
                th.textContent = h;
                headerRow.appendChild(th);
            });
            thead.appendChild(headerRow);
            table.appendChild(thead);
            
            // Body
            const tbody = document.createElement('tbody');
            sampleRows.forEach(row => {
                const tr = document.createElement('tr');
                headers.forEach(h => {
                    const td = document.createElement('td');
                    td.textContent = row[h] || '';
                    tr.appendChild(td);
                });
                tbody.appendChild(tr);
            });
            table.appendChild(tbody);
            
            wrapper.appendChild(table);
            previewDiv.appendChild(wrapper);
            
            const info = document.createElement('small');
            info.className = 'text-muted';
            info.textContent = `Showing ${sampleRows.length} of ${parsedData.length} rows`;
            previewDiv.appendChild(info);
        }

        async function importContacts() {
            console.log('üîµ Import button clicked');
            console.log('Button disabled state:', document.getElementById('importBtn').disabled);
            console.log('parsedData length:', parsedData.length);
            
            const audienceId = document.getElementById('audienceId').value.trim();
            console.log('Audience ID:', audienceId);
            
            if (!audienceId) {
                alert('Please enter an Audience ID');
                return;
            }

            const columnMapping = {
                phone: document.getElementById('phoneColumn').value,
                name: document.getElementById('nameColumn').value,
                consentStatus: document.getElementById('consentColumn').value,
                tags: document.getElementById('tagsColumn').value
            };
            
            console.log('Column mapping:', columnMapping);

            if (!columnMapping.phone) {
                alert('Please select a phone number column');
                return;
            }
            
            // Disable button during import
            const importBtn = document.getElementById('importBtn');
            const originalText = importBtn.innerHTML;
            importBtn.disabled = true;
            importBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importing...';

            try {
                const importMethod = document.querySelector('input[name="importMethod"]:checked').value;
                let response;

                if (importMethod === 'csv') {
                    const fileInput = document.getElementById('csvFile');
                    if (!fileInput.files || !fileInput.files[0]) {
                        alert('Please select a CSV file');
                        importBtn.disabled = false;
                        importBtn.innerHTML = originalText;
                        return;
                    }
                    
                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('audienceId', audienceId);
                    formData.append('columnMapping', JSON.stringify(columnMapping));

                    console.log('Uploading CSV file...');
                    response = await fetch('/api/bulk/audiences/import-csv', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // Paste import
                    const pasteData = document.getElementById('pasteData').value;
                    if (!pasteData || !pasteData.trim()) {
                        alert('Please paste some data');
                        importBtn.disabled = false;
                        importBtn.innerHTML = originalText;
                        return;
                    }
                    
                    console.log('Sending paste data...', {
                        audienceId,
                        dataLength: pasteData.length,
                        columnMapping
                    });
                    
                    response = await fetch('/api/bulk/audiences/import-paste', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            audienceId,
                            pasteData,
                            columnMapping
                        })
                    });
                }

                if (response.ok) {
                    const result = await response.json();
                    console.log('Import result:', result);
                    
                    let message = `‚úÖ Import completed!\n\n`;
                    if (result.imported !== undefined) message += `‚úÖ New contacts imported: ${result.imported}\n`;
                    if (result.updated !== undefined) message += `üîÑ Existing contacts updated: ${result.updated}\n`;
                    if (result.skipped !== undefined) message += `‚è≠Ô∏è Contacts skipped: ${result.skipped}\n`;
                    if (result.summary) {
                        message += `\nSummary:\n`;
                        message += `üìä Total processed: ${result.summary.total}\n`;
                        message += `‚úÖ Valid: ${result.summary.valid}\n`;
                        message += `‚ùå Invalid: ${result.summary.invalid}\n`;
                        if (result.summary.dndFiltered) {
                            message += `üö´ Filtered by DND: ${result.summary.dndFiltered}\n`;
                        }
                    }
                    
                    alert(message);
                    
                    // Close modal
                    const modalElement = document.getElementById('importModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) modal.hide();
                    
                    // Clear form
                    document.getElementById('audienceId').value = '';
                    document.getElementById('pasteData').value = '';
                    document.getElementById('csvFile').value = '';
                    parsedData = [];
                    updateDataPreview();
                    
                    // Reload data
                    await loadContacts();
                    await loadStats();
                } else {
                    const error = await response.json();
                    console.error('Import error response:', error);
                    alert('‚ùå Import failed: ' + (error.error || 'Unknown error'));
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Import failed: ' + error.message);
            } finally {
                // Re-enable button
                importBtn.disabled = false;
                importBtn.innerHTML = originalText;
            }
        }

        async function addToDnd(phone = null) {
            const phoneNumber = phone || document.getElementById('dndPhone').value.trim();
            
            if (!phoneNumber) {
                alert('Please enter a phone number');
                return;
            }

            try {
                const response = await fetch('/api/bulk/audiences/dnd', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        phone: phoneNumber,
                        reason: 'Manual addition'
                    })
                });

                if (response.ok) {
                    alert('Added to DND list successfully');
                    if (!phone) document.getElementById('dndPhone').value = '';
                    loadDndList();
                    loadStats();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.error);
                }
            } catch (error) {
                console.error('Error adding to DND:', error);
                alert('Error adding to DND list');
            }
        }

        // Delete contact
        async function deleteContact(contactId) {
            if (!confirm('Delete this contact? If it has message history it will be anonymized.')) return;
            let url = `/api/bulk/audiences/${contactId}`;
            try {
                let response = await fetch(url, { method: 'DELETE' });
                if (!response.ok) {
                    const errData = await response.json().catch(()=>({}));
                    // If constraint or still failing, offer force cascade
                    if (errData.error && errData.error.includes('retry with ?force=true')) {
                        if (confirm('Contact referenced by sends. Force delete (this will remove related send records)?')) {
                            response = await fetch(url + '?force=true', { method: 'DELETE' });
                        } else {
                            return;
                        }
                    } else if (errData.error === 'Failed to delete contact') {
                        // attempt force if user agrees
                        if (confirm('Delete failed. Attempt forced cascade delete?')) {
                            response = await fetch(url + '?force=true', { method: 'DELETE' });
                        } else {
                            alert('Deletion cancelled');
                            return;
                        }
                    } else if (!response.ok) {
                        alert('Error deleting contact: ' + (errData.error || response.status));
                        return;
                    }
                }
                const data = await response.json();
                if (data.anonymized) {
                    alert('Contact anonymized (history preserved).');
                } else if (data.deleted) {
                    alert('Contact deleted successfully.');
                } else {
                    alert(data.message || 'Operation complete');
                }
                await loadContacts();
                await loadStats();
            } catch (e) {
                console.error('Error deleting contact:', e);
                alert('Error deleting contact: ' + e.message);
            }
        }

        async function loadDndList() {
            // This would load the DND list - placeholder for now
            document.getElementById('dndList').innerHTML = 
                '<div class="text-center text-muted">DND list functionality coming soon</div>';
        }

        // Event listeners
        document.getElementById('consentFilter').addEventListener('change', loadContacts);
        document.getElementById('searchContacts').addEventListener('input', debounce(loadContacts, 500));
        
        // CSV upload zone click handler (CSP-compliant)
        document.getElementById('csvUploadZone').addEventListener('click', function() {
            console.log('‚úÖ CSV upload zone clicked');
            document.getElementById('csvFile').click();
        });
        
        // Import button click handler (CSP-compliant)
        document.getElementById('importBtn').addEventListener('click', function() {
            console.log('‚úÖ Import button clicked via event listener');
            importContacts();
        });
        
        // Add to DND button handler (CSP-compliant)
        document.getElementById('addToDndBtn').addEventListener('click', function() {
            console.log('‚úÖ Add to DND button clicked');
            addToDnd();
        });

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Initialize
        loadStats();
        loadContacts();
    </script>
</body>
</html>
