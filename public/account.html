<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Multi-Phone Account Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <link rel="stylesheet" href="assets/styles/app.css" />
  <style>
    .phone-id-input {
      font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
    }
    .legacy-section {
      background: linear-gradient(135deg, #e3f2fd 0%, #f3e5f5 100%);
      border: 2px solid #2196f3;
      border-radius: 12px;
      padding: 1.5rem;
    }
  </style>
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <i class="fab fa-whatsapp me-2"></i>WA Automation
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="mainNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item">
            <a class="nav-link" href="multi-account.html">
              <i class="fas fa-users me-1"></i>Multi-Account UI
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="index.html">
              <i class="fas fa-home me-1"></i>Dashboard
            </a>
          </li>
        </ul>
      </div>
    </div>
  </nav>

  <main class="container py-4">
    <div class="page-header">
      <div class="d-flex justify-content-between align-items-center flex-wrap">
        <div>
          <h1>
            <i class="fas fa-mobile-alt me-2"></i>Multi-Phone Account Manager
          </h1>
          <p class="text-muted mb-0">Manage multiple WhatsApp accounts with phone_id-based isolation</p>
        </div>
        <a href="index.html" class="btn btn-outline-secondary mt-2 mt-md-0">
          <i class="fas fa-arrow-left me-1"></i>Back
        </a>
      </div>
    </div>

    <!-- Legacy Account Section -->
    <div class="legacy-section p-4 mb-4">
      <div class="row align-items-center">
        <div class="col-md-8">
          <h5 class="mb-2">
            <i class="fas fa-history text-primary me-2"></i>Legacy WhatsApp Account
          </h5>
          <p class="text-muted mb-2">
            Original single-account system for backward compatibility
          </p>
          <div id="legacyStatusBadge" class="mb-2">
            <span class="badge bg-secondary">Loading...</span>
          </div>
        </div>
        <div class="col-md-4 text-end">
          <div class="d-flex flex-column gap-2">
            <button class="btn btn-primary btn-sm" id="btnLegacyStatus">
              <i class="fas fa-info-circle me-1"></i>Check Status
            </button>
            <button class="btn btn-outline-warning btn-sm" id="btnLegacyQR">
              <i class="fas fa-qrcode me-1"></i>Get QR Code
            </button>
            <button class="btn btn-outline-danger btn-sm" id="btnLegacyLogout">
              <i class="fas fa-sign-out-alt me-1"></i>Logout
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Multi-Account Management -->
    <div class="row g-4">
      <!-- Account Creation -->
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header bg-primary text-white">
            <h6 class="mb-0">
              <i class="fas fa-plus-circle me-2"></i>Create New Account
            </h6>
          </div>
          <div class="card-body">
            <form id="createAccountForm">
              <div class="mb-3">
                <label for="phoneId" class="form-label">Phone ID *</label>
                <input type="text" class="form-control phone-id-input" id="phoneId" 
                       placeholder="e.g., user123, phone_001" 
                       pattern="[a-zA-Z0-9_-]+" 
                       title="Only letters, numbers, hyphens, and underscores allowed">
                <div class="form-text">Unique identifier for this WhatsApp account</div>
              </div>
              <div class="mb-3">
                <label for="accountName" class="form-label">Account Name</label>
                <input type="text" class="form-control" id="accountName" 
                       placeholder="e.g., John's Business Account">
              </div>
              <div class="mb-3">
                <label for="webhookUrl" class="form-label">Webhook URL (Optional)</label>
                <input type="url" class="form-control" id="webhookUrl" 
                       placeholder="https://your-server.com/webhook">
              </div>
              <button type="submit" class="btn btn-success w-100" id="createBtn">
                <i class="fas fa-plus me-1"></i>Create Account
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- QR Code Display -->
      <div class="col-lg-8">
        <div class="card h-100">
          <div class="card-header bg-warning text-dark d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-qrcode me-2"></i>QR Code Scanner
            </h6>
            <small class="badge bg-dark">Select account to show QR</small>
          </div>
          <div class="card-body qr-container">
            <div id="qrDisplay" class="text-center text-muted">
              <i class="fas fa-mobile-alt fa-3x mb-3 opacity-50"></i>
              <h5>No Account Selected</h5>
              <p class="mb-0">Create or select an account to display its QR code</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Accounts List -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
            <h6 class="mb-0">
              <i class="fas fa-list me-2"></i>All WhatsApp Accounts
            </h6>
            <button class="btn btn-light btn-sm" id="refreshAccountsBtn">
              <i class="fas fa-sync-alt me-1"></i>Refresh
            </button>
          </div>
          <div class="card-body">
            <div id="accountsList">
              <div class="text-center text-muted py-4">
                <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                <p>Loading accounts...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Status Display -->
    <div class="row mt-4">
      <div class="col-12">
        <div class="card">
          <div class="card-header bg-secondary text-white">
            <h6 class="mb-0">
              <i class="fas fa-terminal me-2"></i>System Status & Logs
            </h6>
          </div>
          <div class="card-body">
            <pre id="systemLogs" class="small text-muted mb-0" style="white-space:pre-wrap; max-height: 300px; overflow-y: auto;">
System initialized. Ready to manage WhatsApp accounts.
            </pre>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Global state
    let accounts = [];
    let selectedAccount = null;
    let qrIntervals = new Map(); // Track QR refresh intervals per account

    // Utility functions
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logArea = document.getElementById('systemLogs');
      const prefix = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
      logArea.scrollTop = logArea.scrollHeight;
    }

    function showNotification(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '400px';
      alertDiv.style.boxShadow = '0 8px 24px rgba(0,0,0,0.2)';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }

    function getStatusBadge(status) {
      switch (status) {
        case 'connected':
          return '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Connected</span>';
        case 'pending':
          return '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Pending QR Scan</span>';
        case 'disconnected':
          return '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Disconnected</span>';
        default:
          return '<span class="badge bg-secondary"><i class="fas fa-question-circle me-1"></i>Unknown</span>';
      }
    }

    // API Functions
    async function createAccount() {
      const phoneId = document.getElementById('phoneId').value.trim();
      const accountName = document.getElementById('accountName').value.trim();
      const webhookUrl = document.getElementById('webhookUrl').value.trim();

      if (!phoneId) {
        showNotification('‚ùå Phone ID is required', 'danger');
        return;
      }

      if (!/^[a-zA-Z0-9_-]+$/.test(phoneId)) {
        showNotification('‚ùå Phone ID can only contain letters, numbers, hyphens, and underscores', 'danger');
        return;
      }

      const createBtn = document.getElementById('createBtn');
      const originalText = createBtn.innerHTML;
      createBtn.disabled = true;
      createBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Creating...';

      try {
        const response = await fetch('/api/accounts/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            phone_id: phoneId,
            name: accountName || `Account ${phoneId}`,
            webhook_url: webhookUrl || null
          })
        });

        const data = await response.json();

        if (response.ok) {
          log(`Account created: ${phoneId}`, 'success');
          showNotification(`‚úÖ Account '${phoneId}' created successfully!`, 'success');
          
          // Clear form
          document.getElementById('createAccountForm').reset();
          
          // Refresh accounts list
          await loadAccounts();
          
          // Auto-select and show QR for new account
          selectAccount(phoneId);
          
        } else {
          log(`Failed to create account: ${data.error}`, 'error');
          showNotification(`‚ùå ${data.error || 'Failed to create account'}`, 'danger');
        }
      } catch (error) {
        log(`Error creating account: ${error.message}`, 'error');
        showNotification(`‚ùå Error: ${error.message}`, 'danger');
      } finally {
        createBtn.disabled = false;
        createBtn.innerHTML = originalText;
      }
    }

    async function loadAccounts() {
      try {
        const response = await fetch('/api/accounts');
        const data = await response.json();

        if (response.ok) {
          accounts = data.accounts;
          renderAccountsList();
          log(`Loaded ${accounts.length} accounts`, 'info');
        } else {
          log(`Failed to load accounts: ${data.error}`, 'error');
        }
      } catch (error) {
        log(`Error loading accounts: ${error.message}`, 'error');
      }
    }

    function renderAccountsList() {
      const container = document.getElementById('accountsList');
      
      if (accounts.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted py-4">
            <i class="fas fa-inbox fa-2x mb-3"></i>
            <h5>No Accounts Found</h5>
            <p>Create your first WhatsApp account using the form above</p>
          </div>
        `;
        return;
      }

      container.innerHTML = accounts.map(account => `
        <div class="account-card card mb-3 status-${account.status}" data-phone-id="${account.phone_id}">
          <div class="card-body">
            <div class="row align-items-center">
              <div class="col-md-6">
                <h6 class="mb-1">
                  <i class="fas fa-mobile-alt me-2"></i>${account.name || account.phone_id}
                </h6>
                <p class="text-muted small mb-1">
                  <strong>Phone ID:</strong> <code>${account.phone_id}</code>
                </p>
                <p class="text-muted small mb-2">
                  <strong>Created:</strong> ${new Date(account.created_at).toLocaleString()}
                </p>
                ${getStatusBadge(account.status)}
              </div>
              <div class="col-md-6 text-end">
                <div class="account-actions">
                  <button class="btn btn-primary btn-xs" onclick="selectAccount('${account.phone_id}')">
                    <i class="fas fa-qrcode me-1"></i>Show QR
                  </button>
                  <button class="btn btn-info btn-xs" onclick="checkAccountStatus('${account.phone_id}')">
                    <i class="fas fa-sync-alt me-1"></i>Status
                  </button>
                  <button class="btn btn-warning btn-xs" onclick="refreshAccountQR('${account.phone_id}')">
                    <i class="fas fa-refresh me-1"></i>Refresh QR
                  </button>
                  <button class="btn btn-danger btn-xs" onclick="deleteAccount('${account.phone_id}')">
                    <i class="fas fa-trash me-1"></i>Delete
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    async function selectAccount(phoneId) {
      selectedAccount = phoneId;
      log(`Selected account: ${phoneId}`, 'info');
      
      // Highlight selected account
      document.querySelectorAll('.account-card').forEach(card => {
        card.classList.remove('border-primary');
      });
      document.querySelector(`[data-phone-id="${phoneId}"]`)?.classList.add('border-primary');
      
      // Show QR code
      await showAccountQR(phoneId);
    }

    async function showAccountQR(phoneId, retryCount = 0) {
      const qrDisplay = document.getElementById('qrDisplay');
      const maxRetries = 10; // Maximum number of retries
      
      qrDisplay.innerHTML = `
        <div class="text-center">
          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
          <h5>Loading QR Code</h5>
          <p class="text-muted">Generating QR code for ${phoneId}...</p>
          ${retryCount > 0 ? `<small class="text-muted">Attempt ${retryCount + 1}/${maxRetries}</small>` : ''}
        </div>
      `;

      try {
        const response = await fetch(`/api/accounts/${phoneId}/qr`);
        const data = await response.json();

        if (response.ok && data.qr_code) {
          const timestamp = new Date().toLocaleTimeString();
          qrDisplay.innerHTML = `
            <div class="text-center">
              <h5 class="mb-3">
                <i class="fas fa-mobile-alt me-2 text-primary"></i>${phoneId}
              </h5>
              <img src="${data.qr_code}" class="img-fluid border rounded shadow-sm mb-3" 
                   alt="QR Code for ${phoneId}" style="max-width: 300px;">
              <div class="alert alert-info mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>How to connect:</h6>
                <ol class="mb-0 text-start">
                  <li>Open WhatsApp on your phone</li>
                  <li>Go to Settings > Linked Devices</li>
                  <li>Tap "Link a Device"</li>
                  <li>Scan this QR code</li>
                </ol>
              </div>
              <small class="text-muted d-block">
                <i class="fas fa-clock me-1"></i>Generated: ${timestamp}
              </small>
              <div class="mt-3">
                <button class="btn btn-outline-primary btn-sm" onclick="refreshAccountQR('${phoneId}')">
                  <i class="fas fa-sync-alt me-1"></i>Refresh QR
                </button>
                <button class="btn btn-outline-success btn-sm ms-2" onclick="checkAccountStatus('${phoneId}')">
                  <i class="fas fa-check me-1"></i>Check Status
                </button>
              </div>
            </div>
          `;
          
          // Auto-refresh QR every 30 seconds
          if (qrIntervals.has(phoneId)) {
            clearInterval(qrIntervals.get(phoneId));
          }
          const interval = setInterval(() => refreshAccountQR(phoneId), 30000);
          qrIntervals.set(phoneId, interval);
          
        } else if (response.status === 202 && data.retry_after) {
          // Session is being initialized, retry after delay
          if (retryCount < maxRetries) {
            const nextRetry = retryCount + 1;
            const progressPercent = (nextRetry / maxRetries) * 100;
            
            qrDisplay.innerHTML = `
              <div class="text-center text-info">
                <i class="fas fa-sync-alt fa-spin fa-2x mb-3"></i>
                <h5>Initializing Session</h5>
                <p>${data.message || 'Setting up WhatsApp session...'}</p>
                <small class="text-muted d-block mb-2">Attempt ${nextRetry}/${maxRetries} - Retrying in ${data.retry_after} seconds...</small>
                <div class="progress" style="height: 8px; max-width: 300px; margin: 0 auto;">
                  <div class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                       role="progressbar" style="width: ${progressPercent}%"></div>
                </div>
              </div>
            `;
            
            // Auto-retry after the specified delay
            setTimeout(() => {
              showAccountQR(phoneId, nextRetry);
            }, data.retry_after * 1000);
          } else {
            qrDisplay.innerHTML = `
              <div class="text-center text-danger">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <h5>Timeout</h5>
                <p>QR code generation took too long. The session might need to be restarted.</p>
                <button class="btn btn-primary me-2" onclick="showAccountQR('${phoneId}', 0)">
                  <i class="fas fa-retry me-1"></i>Try Again
                </button>
                <button class="btn btn-warning" onclick="restartAccount('${phoneId}')">
                  <i class="fas fa-sync-alt me-1"></i>Restart Session
                </button>
              </div>
            `;
          }
          
        } else if (data.authenticated) {
          qrDisplay.innerHTML = `
            <div class="text-center text-success">
              <i class="fas fa-check-circle fa-2x mb-3"></i>
              <h5>Already Connected</h5>
              <p>This account is already authenticated!</p>
              <p class="text-muted">Phone: ${data.phone_number || 'Unknown'}</p>
            </div>
          `;
        } else {
          qrDisplay.innerHTML = `
            <div class="text-center text-warning">
              <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
              <h5>QR Code Not Available</h5>
              <p>${data.message || 'Unable to generate QR code'}</p>
              <button class="btn btn-warning" onclick="showAccountQR('${phoneId}', 0)">
                <i class="fas fa-retry me-1"></i>Try Again
              </button>
            </div>
          `;
        }
      } catch (error) {
        qrDisplay.innerHTML = `
          <div class="text-center text-danger">
            <i class="fas fa-times-circle fa-2x mb-3"></i>
            <h5>Error Loading QR Code</h5>
            <p>${error.message}</p>
            <button class="btn btn-danger" onclick="showAccountQR('${phoneId}', 0)">
              <i class="fas fa-retry me-1"></i>Retry
            </button>
          </div>
        `;
        log(`Error loading QR for ${phoneId}: ${error.message}`, 'error');
      }
    }

    async function refreshAccountQR(phoneId) {
      if (selectedAccount === phoneId) {
        await showAccountQR(phoneId, 0);
      }
    }

    async function restartAccount(phoneId) {
      if (!confirm(`‚ö†Ô∏è Are you sure you want to restart the session for ${phoneId}?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/accounts/${phoneId}/refresh`, {
          method: 'POST'
        });
        const data = await response.json();

        if (data.success) {
          log(`Session restarted for ${phoneId}`, 'success');
          showNotification(`‚úÖ Session restarted for ${phoneId}`, 'success');
          
          // Wait a moment then show QR
          setTimeout(() => {
            showAccountQR(phoneId, 0);
          }, 2000);
        } else {
          log(`Error restarting session: ${data.message}`, 'error');
          showNotification(`‚ùå ${data.message}`, 'danger');
        }
      } catch (error) {
        log(`Error restarting session: ${error.message}`, 'error');
        showNotification(`‚ùå Error: ${error.message}`, 'danger');
      }
    }

    async function checkAccountStatus(phoneId) {
      try {
        // This would require a new endpoint to check individual account status
        log(`Checking status for ${phoneId}`, 'info');
        showNotification(`üîÑ Checking status for ${phoneId}...`, 'info');
        
        // For now, refresh the accounts list
        await loadAccounts();
      } catch (error) {
        log(`Error checking status for ${phoneId}: ${error.message}`, 'error');
      }
    }

    async function deleteAccount(phoneId) {
      if (!confirm(`‚ö†Ô∏è Are you sure you want to delete account '${phoneId}'?\n\nThis action cannot be undone and will:\n‚Ä¢ Remove the account permanently\n‚Ä¢ Clear all associated data\n‚Ä¢ Disconnect the WhatsApp session`)) {
        return;
      }

      try {
        const response = await fetch(`/api/accounts/${phoneId}`, {
          method: 'DELETE'
        });

        const data = await response.json();

        if (response.ok) {
          log(`Account deleted: ${phoneId}`, 'success');
          showNotification(`‚úÖ Account '${phoneId}' deleted successfully`, 'success');
          
          // Clear QR if this was the selected account
          if (selectedAccount === phoneId) {
            selectedAccount = null;
            document.getElementById('qrDisplay').innerHTML = `
              <div class="text-center text-muted">
                <i class="fas fa-mobile-alt fa-3x mb-3 opacity-50"></i>
                <h5>Account Deleted</h5>
                <p class="mb-0">Select another account to show its QR code</p>
              </div>
            `;
          }
          
          // Clear QR interval
          if (qrIntervals.has(phoneId)) {
            clearInterval(qrIntervals.get(phoneId));
            qrIntervals.delete(phoneId);
          }
          
          // Refresh accounts list
          await loadAccounts();
          
        } else {
          log(`Failed to delete account: ${data.error}`, 'error');
          showNotification(`‚ùå ${data.error || 'Failed to delete account'}`, 'danger');
        }
      } catch (error) {
        log(`Error deleting account: ${error.message}`, 'error');
        showNotification(`‚ùå Error: ${error.message}`, 'danger');
      }
    }

    // Legacy account functions
    async function checkLegacyStatus() {
      try {
        const response = await fetch('/status');
        const data = await response.json();
        
        const badge = document.getElementById('legacyStatusBadge');
        if (data.legacy_client && data.legacy_client.ready) {
          badge.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Connected</span>';
        } else {
          badge.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-clock me-1"></i>Waiting for QR</span>';
        }
        
        log(`Legacy status: ${data.legacy_client?.ready ? 'Connected' : 'Not connected'}`, 'info');
      } catch (error) {
        log(`Error checking legacy status: ${error.message}`, 'error');
      }
    }

    async function showLegacyQR() {
      selectedAccount = 'legacy';
      const qrDisplay = document.getElementById('qrDisplay');
      
      qrDisplay.innerHTML = `
        <div class="text-center">
          <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
          <h5>Loading Legacy QR Code</h5>
          <p class="text-muted">Loading QR code for legacy account...</p>
        </div>
      `;

      try {
        const response = await fetch('/qr');
        const data = await response.json();

        if (data.authenticated) {
          qrDisplay.innerHTML = `
            <div class="text-center text-success">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <h5>Legacy Account Connected</h5>
              <p class="text-muted">Your legacy WhatsApp account is already connected</p>
            </div>
          `;
        } else if (data.qr) {
          const timestamp = new Date().toLocaleTimeString();
          qrDisplay.innerHTML = `
            <div class="text-center">
              <h5 class="mb-3">
                <i class="fas fa-history me-2 text-primary"></i>Legacy Account
              </h5>
              <img src="${data.qr}" class="img-fluid border rounded shadow-sm mb-3" 
                   alt="Legacy QR Code" style="max-width: 300px;">
              <div class="alert alert-warning mb-3">
                <h6><i class="fas fa-info-circle me-2"></i>Legacy Account:</h6>
                <p class="mb-0">This is the original single-account system for backward compatibility</p>
              </div>
              <small class="text-muted d-block">
                <i class="fas fa-clock me-1"></i>Generated: ${timestamp}
              </small>
            </div>
          `;
        }
      } catch (error) {
        qrDisplay.innerHTML = `
          <div class="text-center text-danger">
            <i class="fas fa-times-circle fa-2x mb-3"></i>
            <h5>Error Loading Legacy QR</h5>
            <p>${error.message}</p>
          </div>
        `;
        log(`Error loading legacy QR: ${error.message}`, 'error');
      }
    }

    async function logoutLegacy() {
      if (!confirm('‚ö†Ô∏è Are you sure you want to logout the legacy account?')) {
        return;
      }

      try {
        const response = await fetch('/account/logout', { method: 'POST' });
        if (response.ok) {
          log('Legacy account logged out', 'success');
          showNotification('‚úÖ Legacy account logged out', 'success');
          await checkLegacyStatus();
        }
      } catch (error) {
        log(`Error logging out legacy account: ${error.message}`, 'error');
      }
    }

    // Event listeners
    document.getElementById('createAccountForm').addEventListener('submit', (e) => {
      e.preventDefault();
      createAccount();
    });

    document.getElementById('refreshAccountsBtn').addEventListener('click', loadAccounts);
    document.getElementById('btnLegacyStatus').addEventListener('click', checkLegacyStatus);
    document.getElementById('btnLegacyQR').addEventListener('click', showLegacyQR);
    document.getElementById('btnLegacyLogout').addEventListener('click', logoutLegacy);

    // Initialize
    document.addEventListener('DOMContentLoaded', async () => {
      log('Multi-Phone Account Manager initialized', 'success');
      await loadAccounts();
      await checkLegacyStatus();
    });

    // Cleanup intervals on page unload
    window.addEventListener('beforeunload', () => {
      qrIntervals.forEach(interval => clearInterval(interval));
    });
  </script>
</body>
</html>
