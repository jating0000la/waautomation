<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Account & Device</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="assets/styles/app.css" />
</head>
<body>
  <nav class="navbar navbar-expand-lg navbar-dark bg-success">
    <div class="container">
      <a class="navbar-brand" href="index.html">WA Automation</a>
    </div>
  </nav>
  <main class="container py-4">
    <div class="page-header">
      <h1 class="h4 mb-0">Account & Device</h1>
      <a href="index.html" class="subtle-link">&larr; Back</a>
    </div>
    <div class="row g-4">
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Actions</strong></div>
          <div class="card-body d-grid gap-2">
            <button class="btn btn-whatsapp" id="btnStatus"><i class="fas fa-info-circle me-1"></i>Status</button>
            <button class="btn btn-outline-secondary" id="btnQR"><i class="fas fa-qrcode me-1"></i>Get QR Code</button>
            <button class="btn btn-outline-danger" id="btnLogout"><i class="fas fa-sign-out-alt me-1"></i>Logout</button>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>Status</strong></div>
          <div class="card-body">
            <div id="statusBadge" class="mb-2"><span class="badge bg-secondary">Unknown</span></div>
            <pre id="result" class="small text-muted mb-0" style="white-space:pre-wrap"></pre>
          </div>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="card h-100">
          <div class="card-header bg-white"><strong>QR Code</strong></div>
          <div class="card-body d-flex flex-column align-items-center justify-content-center" id="qr">
            <div class="text-muted small">No QR loaded</div>
          </div>
        </div>
      </div>
    </div>
  </main>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/js/all.min.js" defer></script>
  <script>
    let qrCheckInterval = null;
    let qrRefreshInterval = null;
    let statusCheckInterval = null;
    let lastConnectionStatus = null;
    
    async function fetchStatus(){
      try {
        const res = await fetch('/status');
        const data = await res.json();
        document.getElementById('result').textContent = JSON.stringify(data, null, 2);
        const badge = document.getElementById('statusBadge');
        
        if (data.ready) {
          badge.innerHTML = '<span class="badge bg-success"><i class="fas fa-check-circle me-1"></i>Ready & Connected</span>';
          
          // Show connection change notification
          if (lastConnectionStatus === false) {
            showNotification('‚úÖ WhatsApp Connected Successfully!', 'success');
          }
          lastConnectionStatus = true;
          
          // Stop checking for QR if already connected
          if (qrCheckInterval) {
            clearInterval(qrCheckInterval);
            qrCheckInterval = null;
          }
          if (qrRefreshInterval) {
            clearInterval(qrRefreshInterval);
            qrRefreshInterval = null;
          }
          
          document.getElementById('qr').innerHTML = `
            <div class="text-success text-center">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <h5 class="mb-2">Already Connected</h5>
              <p class="small text-muted mb-0">Your WhatsApp is connected and ready</p>
            </div>
          `;
        } else {
          badge.innerHTML = '<span class="badge bg-warning text-dark"><i class="fas fa-qrcode me-1"></i>Waiting for QR Scan</span>';
          
          // Show disconnection notification
          if (lastConnectionStatus === true) {
            showNotification('‚ö†Ô∏è WhatsApp Disconnected. Please scan QR code.', 'warning');
          }
          lastConnectionStatus = false;
          
          // Auto-fetch QR if not ready
          if (!qrCheckInterval) {
            fetchQR();
            qrCheckInterval = setInterval(fetchQR, 3000); // Check every 3 seconds
          }
          
          // Auto-refresh QR every 10 seconds
          if (!qrRefreshInterval) {
            qrRefreshInterval = setInterval(fetchQR, 10000); // Refresh every 10 seconds
          }
        }
      } catch(e) {
        document.getElementById('result').textContent = 'Error: ' + e.message;
        document.getElementById('statusBadge').innerHTML = '<span class="badge bg-danger"><i class="fas fa-times-circle me-1"></i>Error</span>';
      }
    }
    
    async function fetchQR(){
      const qrDiv = document.getElementById('qr');
      try {
        console.log('Fetching QR code...');
        const res = await fetch('/qr');
        console.log('QR response status:', res.status);
        
        // Parse response once
        const data = await res.json();
        console.log('QR data:', data);
        
        // Already authenticated
        if (res.status === 200 && data.authenticated) {
          console.log('Already authenticated');
          qrDiv.innerHTML = `
            <div class="text-success text-center">
              <i class="fas fa-check-circle fa-3x mb-3"></i>
              <h5 class="mb-2">Already Connected</h5>
              <p class="small text-muted mb-0">Your WhatsApp is connected and ready</p>
            </div>
          `;
          return;
        }
        
        // Has QR code
        if (data.qr) {
          console.log('QR code received, displaying...');
          const timestamp = new Date().toLocaleTimeString();
          qrDiv.innerHTML = `
            <div class="text-center">
              <img src="${data.qr}" class="img-fluid border rounded shadow-sm mb-3" alt="QR Code" style="max-width: 280px;"/>
              <p class="text-success mb-1 fw-bold"><i class="fas fa-mobile-alt me-1"></i>Scan with WhatsApp</p>
              <small class="text-muted d-block mb-2">Open WhatsApp > Settings > Linked Devices > Link a Device</small>
              <small class="text-muted"><i class="fas fa-clock me-1"></i>Last updated: ${timestamp}</small>
              <div class="mt-2">
                <small class="badge bg-info">Auto-refreshes every 10s</small>
              </div>
            </div>
          `;
          return;
        }
        
        // QR not ready yet (404 or no qr in data)
        if (res.status === 404 || data.error) {
          console.log('QR not ready:', data.message || data.error);
          qrDiv.innerHTML = `
            <div class="text-muted text-center">
              <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
              <p class="mb-1">Generating QR Code...</p>
              <small>${data.message || 'Please wait, this may take a moment'}</small>
            </div>
          `;
          return;
        }
        
        // Fallback - unexpected response
        console.warn('Unexpected QR response:', data);
        qrDiv.innerHTML = `
          <div class="text-warning text-center">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
            <p class="mb-1">QR not available</p>
            <small class="text-muted">${data.message || 'Please try refreshing'}</small>
          </div>
        `;
        
      } catch(e) {
        console.error('QR fetch error:', e);
        qrDiv.innerHTML = `
          <div class="text-danger text-center">
            <i class="fas fa-times-circle fa-2x mb-2"></i>
            <p class="mb-1">Error loading QR</p>
            <small>${e.message}</small>
            <button class="btn btn-sm btn-outline-danger mt-2" onclick="fetchQR()">Retry</button>
          </div>
        `;
      }
    }
    
    async function logout(){
      // Show confirmation dialog
      if (!confirm('‚ö†Ô∏è Are you sure you want to logout from WhatsApp?\n\nThis will:\n‚Ä¢ Disconnect your WhatsApp session\n‚Ä¢ Clear all cached data\n‚Ä¢ Require QR scan to reconnect')) {
        return;
      }
      
      // Disable logout button to prevent double-clicks
      const logoutBtn = document.getElementById('btnLogout');
      const originalText = logoutBtn.innerHTML;
      logoutBtn.disabled = true;
      logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Logging out...';
      
      try {
        const res = await fetch('/account/logout', {method: 'POST'});
        const text = await res.text();
        
        // Update result display
        document.getElementById('result').textContent = text;
        
        // Update status badge
        document.getElementById('statusBadge').innerHTML = '<span class="badge bg-secondary"><i class="fas fa-power-off me-1"></i>Logged Out</span>';
        
        // Show success notification
        showNotification('‚úÖ Logged out successfully! Scan QR code to reconnect.', 'success');
        
        // Clear intervals
        if (qrCheckInterval) {
          clearInterval(qrCheckInterval);
          qrCheckInterval = null;
        }
        if (qrRefreshInterval) {
          clearInterval(qrRefreshInterval);
          qrRefreshInterval = null;
        }
        
        // Reset connection status
        lastConnectionStatus = false;
        
        // Show QR code area with message
        document.getElementById('qr').innerHTML = `
          <div class="text-info text-center">
            <i class="fas fa-qrcode fa-3x mb-3"></i>
            <p class="mb-2">Logged out successfully</p>
            <small class="text-muted">Fetching new QR code...</small>
          </div>
        `;
        
        // Restart status check after 2 seconds
        setTimeout(() => {
          fetchStatus();
        }, 2000);
        
      } catch(e) {
        document.getElementById('result').textContent = 'Error: ' + e.message;
        showNotification('‚ùå Error during logout: ' + e.message, 'danger');
      } finally {
        // Re-enable logout button
        logoutBtn.disabled = false;
        logoutBtn.innerHTML = originalText;
      }
    }
    
    // Show toast notification
    function showNotification(message, type = 'info') {
      const alertDiv = document.createElement('div');
      alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3`;
      alertDiv.style.zIndex = '9999';
      alertDiv.style.minWidth = '400px';
      alertDiv.style.boxShadow = '0 8px 24px rgba(0,0,0,0.2)';
      alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      document.body.appendChild(alertDiv);
      setTimeout(() => alertDiv.remove(), 5000);
    }
    
    // Attach event listeners to buttons
    document.getElementById('btnStatus')?.addEventListener('click', () => {
      fetchStatus();
      showNotification('üîÑ Refreshing status...', 'info');
    });
    document.getElementById('btnQR')?.addEventListener('click', () => {
      fetchQR();
      showNotification('üîÑ Refreshing QR code...', 'info');
    });
    document.getElementById('btnLogout')?.addEventListener('click', logout);
    
    // Auto-load status on page load
    fetchStatus();
    
    // Check status every 5 seconds
    statusCheckInterval = setInterval(fetchStatus, 5000);
    
    // Clean up intervals when page is closed
    window.addEventListener('beforeunload', () => {
      if (qrCheckInterval) clearInterval(qrCheckInterval);
      if (qrRefreshInterval) clearInterval(qrRefreshInterval);
      if (statusCheckInterval) clearInterval(statusCheckInterval);
    });
  </script>
</body>
</html>
